<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title>

<style>
:root{
  --bg:#070b13;--b:rgba(255,255,255,.12);
  --t:#eaf1ff;--m:rgba(255,255,255,.65);
  --g:rgba(46,204,113,.20);
  --a:rgba(241,196,15,.16);
  --r:rgba(231,76,60,.14);
  --bl:rgba(52,152,219,.18);
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{
  margin:0;min-height:100vh;padding:14px;color:var(--t);
  background:
  radial-gradient(900px 700px at 20% 0%,rgba(40,110,255,.25),transparent 55%),
  radial-gradient(900px 700px at 80% 10%,rgba(0,255,170,.18),transparent 55%),
  var(--bg)
}
.card{max-width:1100px;margin:0 auto;border:1px solid var(--b);
border-radius:18px;padding:14px;
background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.04))}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.pill{padding:8px 12px;border:1px solid var(--b);border-radius:999px;
background:rgba(0,0,0,.25);font-weight:800}
.btn{border:1px solid var(--b);background:rgba(255,255,255,.06);
color:var(--t);padding:10px 12px;border-radius:14px;
font-weight:900;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn:disabled{opacity:.55;cursor:not-allowed}
.g{background:var(--g)} .a{background:var(--a)}
.r{background:var(--r)} .bl{background:var(--bl)}
.box{border:1px solid var(--b);border-radius:16px;
background:rgba(0,0,0,.18);padding:12px;margin-top:12px}
.match{border:1px solid var(--b);border-radius:14px;padding:12px;margin-top:10px}
.off{opacity:.7;background:rgba(0,0,0,.4)}
.lockedPick{border-color:rgba(231,76,60,.55)!important;background:rgba(231,76,60,.12)!important}
.mini{color:var(--m);font-weight:750}
select{padding:8px;border-radius:10px;background:#000;color:#fff;border:1px solid rgba(255,255,255,.18)}
h1{margin:0}

/* âœ… Inline notification */
.notice{
  display:none;
  border:1px solid var(--b);
  border-radius:16px;
  background:rgba(0,0,0,.18);
  padding:10px 12px;
  margin-top:12px;
  font-weight:900;
}
.notice.ok{ border-color:rgba(46,204,113,.45); background:rgba(46,204,113,.12); }
.notice.warn{ border-color:rgba(241,196,15,.45); background:rgba(241,196,15,.10); }
.notice.err{ border-color:rgba(231,76,60,.45); background:rgba(231,76,60,.12); }
</style>
</head>

<body>
<div class="card">
  <h1>ğŸ“Š Dashboard</h1>

  <div class="row">
    <a class="btn" href="leaderboard.html">ğŸ† Leaderboard</a>
    <button class="btn r" id="lo" type="button">Logout</button>
    <div class="pill" id="userPill">Î§ÏÎ®ÏƒÏ„Î·Ï‚:-</div>
    <div class="pill" id="contestInfo">Contest:-</div>
    <div class="pill" id="roundInfo">Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®:-</div>
  </div>

  <div id="notice" class="notice"></div>

  <div class="box">
    <div class="mini" style="font-size:18px;font-weight:900;color:gold">
      ğŸ <span id="prizeText">-</span>
    </div>
  </div>

  <div class="box" id="blockedBox"
       style="display:none;border-color:rgba(231,76,60,.45);background:rgba(231,76,60,.14)">
    <div class="pill">â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹</div>
    <div class="mini" style="margin-top:8px">
      Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÏƒÏ…Î¼Î¼ÎµÏ„Î­Ï‡ÎµÎ¹Ï‚ Î³Î¹Î±Ï„Î¯ Î¿ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Ï€ÏÎ¹Î½ Î¼Ï€ÎµÎ¹Ï‚.
      Î˜Î± Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹Ï‚ ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒ.
    </div>
  </div>

  <div class="box">
    <div class="row" style="margin-top:0">
      <button class="btn r" id="lockBtn" type="button">ğŸ”’ ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÏ‰Î½</button>
      <div class="pill" id="lockState">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: -</div>
      <div class="pill" id="dlPill">Deadline:-</div>

      <div class="pill">Contest: <b><span id="contestCode">-</span></b></div>
      <div class="pill">Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®: <b><span id="contestRound">-</span></b></div>
      <div class="pill">Status: <b><span id="contestStatus">-</span></b></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn bl" id="buyBtn" type="button">ğŸ’¶ Î‘Î³Î¿ÏÎ¬ HELP â‚¬1,99</button>
      <div class="pill" id="helpPill">HELP: -</div>
    </div>

    <div class="mini" style="margin-top:8px">
      Î‘Î½ <b>Î´ÎµÎ½ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚</b> Î¼Î­Ï‡ÏÎ¹ 10â€™ Ï€ÏÎ¹Î½ Ï„Î¿Î½ 1Î¿ Î±Î³ÏÎ½Î±, Ï„Î± Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹Î± ÏƒÎ¿Ï… Î³Î¯Î½Î¿Î½Ï„Î±Î¹ <b>OFF</b> (ÏƒÎ±Î½ Î½Î± Î¼Î·Î½ Î­Ï€Î±Î¹Î¾ÎµÏ‚).
    </div>

    <div class="mini" style="margin-top:8px;opacity:.9">
      Tip (Acode): Î‘Î½ Ï„Î¿ <b>pay.html</b> Î´ÎµÎ½ Î±Î½Î¿Î¯Î³ÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯, Î¬Î½Î¿Î¹Î¾Î­ Ï„Î¿ 1 Ï†Î¿ÏÎ¬ Î¼Îµ <b>Play</b> Î® Ï„ÏÎ­Î¾Îµ server Î³Î¹Î± ÏŒÎ»Î¿ Ï„Î¿ folder.
    </div>
  </div>

  <div id="matches"></div>
</div>

<script>
const K={
  S:'session',A:'activeContest',M:'contestMatches',
  P:'picks',H:'help199',META:'contestMeta',
  WARN:'helpWarn',LOCK:'picksLocked',
  U:'users'
};
const $=i=>document.getElementById(i);
const R=(k,f)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(f))}catch{return f}};
const W=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const now=()=>Date.now();
const sess=()=>R(K.S,null);

function N(msg, type='warn'){
  const el = $('notice');
  if(!el) return;
  const t = String(msg||'').trim();
  if(!t){
    el.textContent = '';
    el.className = 'notice';
    el.style.display = 'none';
    return;
  }
  const cls = (type==='ok'?'ok':type==='err'?'err':'warn');
  el.textContent = t;
  el.className = 'notice ' + cls;
  el.style.display = 'block';
  clearTimeout(window.__n);
  window.__n = setTimeout(()=>N(''), 2600);
}

/* deadline = 10 Î»ÎµÏ€Ï„Î¬ Ï€ÏÎ¹Î½ Ï„Î¿Î½ Ï€ÏÏÏ„Î¿ ON Î±Î³ÏÎ½Î± */
function deadlineMsFromMatches(arr){
  const times=(arr||[])
    .filter(m=>m && m.off!==true)
    .map(m=>new Date(m.startISO).getTime())
    .filter(Number.isFinite);
  if(!times.length) return null;
  return Math.min(...times)-10*60*1000;
}
function fmt(ms){
  const d=new Date(ms);
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0');
  const yy=d.getFullYear(),hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yy} ${hh}:${mi}`;
}

/* LOCK MAP */
function lockAll(){ return R(K.LOCK,{}); }
function isLocked(cid,u){ return !!(lockAll()?.[cid]?.[u]); }
function setLocked(cid,u,val){
  const all=lockAll();
  all[cid]=all[cid]||{};
  all[cid][u]=!!val;
  W(K.LOCK,all);
}

/* HELP */
function helpAll(){ return R(K.H,{}); }
function getHelpRec(cid,u){ return helpAll()?.[cid]?.[u]||null; }
function ensureHelpRec(cid,u){
  const all=helpAll();
  all[cid]=all[cid]||{};
  all[cid][u]=all[cid][u]||{paidAt:null,remaining:0,usedMatchIds:[]};
  all[cid][u].remaining = Number(all[cid][u].remaining||0);
  all[cid][u].usedMatchIds = Array.isArray(all[cid][u].usedMatchIds)?all[cid][u].usedMatchIds:[];
  W(K.H,all);
  return all[cid][u];
}
function isHelpPurchased(rec){ return !!(rec && rec.paidAt); }
function hasHelp(cid,u,mid){
  const rec=getHelpRec(cid,u);
  return (rec?.usedMatchIds||[]).includes(mid);
}

/* PICKS */
function picksAll(){ return R(K.P,{}); }
function getMyMap(cid,u){ return picksAll()?.[cid]?.[u]||{}; }
function savePick(cid,u,mid,val){
  const all=picksAll();
  all[cid]=all[cid]||{};
  all[cid][u]=all[cid][u]||{};
  all[cid][u][mid]={pick:val,ts:now()};
  W(K.P,all);
}
function deletePick(cid,u,mid){
  const all=picksAll();
  if(all?.[cid]?.[u]?.[mid]){ delete all[cid][u][mid]; W(K.P,all); }
}
function setAllOff(cid,u,matches){
  const all=picksAll();
  all[cid]=all[cid]||{};
  all[cid][u]=all[cid][u]||{};
  for(const m of matches){
    if(!m) continue;
    all[cid][u][m.id]={pick:'OFF',ts:now()};
  }
  W(K.P,all);
}

/* HELP WARN */
function warnKey(cid,u){ return `w_${cid}_${u}`; }
function getWarn(cid,u){ return Number((R(K.WARN,{})||{})[warnKey(cid,u)]||0); }
function setWarn(cid,u,v){
  const all=R(K.WARN,{});
  all[warnKey(cid,u)]=Number(v)||0; W(K.WARN,all);
}

function canLockAllPicks(cid,u,matches){
  const map=getMyMap(cid,u);
  for(const m of matches){
    if(!m) continue;
    if(m.off===true) continue;
    const p=(map?.[m.id]?.pick||'').trim();
    if(!p) return false;
    if(p==='OFF') return false;
  }
  return true;
}

/* âœ… GO PAY */
function goPay(){
  const s=sess();
  const active=R(K.A,null);
  const cid=active?.id;
  const matches=R(K.M,[]);
  const dl=deadlineMsFromMatches(matches);
  const timeLocked = (dl && now()>=dl);
  const userLocked = (s && cid) ? isLocked(cid,s.username) : false;

  const meta = (cid ? (R(K.META,{})[cid]||{}) : {});
  const started = meta.contestStarted===true;
  const elig = Array.isArray(meta.eligibleUsers)?meta.eligibleUsers:[];
  const me = String(s?.username||'').toLowerCase();

  // âœ… FIX: ÎœÏ€Î»Î¿ÎºÎ¬ÏÎµÎ¹ ÎœÎŸÎÎŸ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ eligibleUsers ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ Î¼Î­ÏƒÎ±
  const eligLower = elig.map(x=>String(x).toLowerCase());
  const blocked = !!(started && eligLower.length>0 && !eligLower.includes(me));
  if(blocked) return N('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÎ¹Ï‚.','err');

  if(!s) return location.href='login.html';
  if(!cid) return N('â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚','err');

  const validMatches = (matches || []).filter(m => m && m.off !== true);
  if(!validMatches.length) return N('â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚ â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬ HELP','err');

  if(timeLocked) return N('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬','err');
  if(userLocked) return N('ğŸ”’ ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬','err');

  const before = location.href;
  N('â¡ï¸ Î†Î½Î¿Î¹Î³Î¼Î± Î±Î³Î¿ÏÎ¬Ï‚...','warn');

  const tries = [
    'pay.html',
    './pay.html',
    (location.origin ? (location.origin + '/pay.html') : null),
    'http://localhost:8158/pay.html'
  ].filter(Boolean);

  let i = 0;
  const tryNav = ()=>{
    try { window.location.href = tries[i]; } catch(e) {}
    i++;
    setTimeout(()=>{
      if(location.href === before && i < tries.length) return tryNav();
      if(location.href === before){
        N('â›” Î¤Î¿ preview Î´ÎµÎ½ ÏƒÎµÏÎ²Î¯ÏÎµÎ¹ ÏŒÎ»Î± Ï„Î± Î±ÏÏ‡ÎµÎ¯Î±. Î†Î½Î¿Î¹Î¾Îµ Ï„Î¿ pay.html Î¼Îµ Play Î® Ï„ÏÎ­Î¾Îµ server Î³Î¹Î± ÏŒÎ»Î¿ Ï„Î¿ folder.','err');
      }
    }, 180);
  };
  tryNav();
}

/* TOGGLE HELP */
function toggleHelp(cid,u,mid){
  const matches=R(K.M,[]);
  const dl=deadlineMsFromMatches(matches);
  if(dl && now()>=dl) return N('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚','err');
  if(isLocked(cid,u)) return N('ğŸ”’ ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ Ï„Î¹Ï‚ Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï…','err');

  const meta = (R(K.META,{})[cid]||{});
  const started = meta.contestStarted===true;
  const elig = Array.isArray(meta.eligibleUsers)?meta.eligibleUsers:[];
  const me = String(u||'').toLowerCase();

  // âœ… FIX: ÎœÏ€Î»Î¿ÎºÎ¬ÏÎµÎ¹ ÎœÎŸÎÎŸ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ eligibleUsers ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ Î¼Î­ÏƒÎ±
  const eligLower = elig.map(x=>String(x).toLowerCase());
  const blocked = !!(started && eligLower.length>0 && !eligLower.includes(me));
  if(blocked) return N('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹Ï‚.','err');

  const m=(matches||[]).find(x=>x && x.id===mid);
  if(m && m.off===true) return N('OFF Î±Î³ÏÎ½Î±Ï‚ (Î±Î½Î±Î²Î¿Î»Î®)','warn');

  const rec=ensureHelpRec(cid,u);
  if(!isHelpPurchased(rec)) return N('ğŸ’¶ Î ÏÎ­Ï€ÎµÎ¹ Ï€ÏÏÏ„Î± Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÎ¹Ï‚ HELP (â‚¬1,99)','warn');

  if(rec.usedMatchIds.includes(mid)){
    rec.usedMatchIds=rec.usedMatchIds.filter(x=>x!==mid);
    rec.remaining++;
    const all=helpAll(); all[cid]=all[cid]||{}; all[cid][u]=rec; W(K.H,all);
    deletePick(cid,u,mid);
    N('â†©ï¸ Î‘ÎºÏÏÏ‰ÏƒÎ· HELP','ok');
    return render();
  }

  if(rec.remaining<=0) return N('â›” Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¬Î»Î»Î¿ HELP (Î­Î²Î±Î»ÎµÏ‚ Î®Î´Î· 3).','err');
  rec.remaining--;
  rec.usedMatchIds.push(mid);
  const all=helpAll(); all[cid]=all[cid]||{}; all[cid][u]=rec; W(K.H,all);

  savePick(cid,u,mid,'HELP');
  N('âœ… ÎœÏ€Î®ÎºÎµ HELP','ok');
  render();
}

/* LOCK BUTTON */
function onLockBtn(cid,u,matches){
  const dl=deadlineMsFromMatches(matches);
  const validMatches = (matches || []).filter(m => m && m.off !== true);
  if(!validMatches.length) return N('â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚ Î³Î¹Î± ÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±','err');
  const timeLocked = (dl && now()>=dl);
  if(timeLocked) return N('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚','err');

  const meta = (R(K.META,{})[cid]||{});
  const started = meta.contestStarted===true;
  const elig = Array.isArray(meta.eligibleUsers)?meta.eligibleUsers:[];
  const me = String(u||'').toLowerCase();

  // âœ… FIX: ÎœÏ€Î»Î¿ÎºÎ¬ÏÎµÎ¹ ÎœÎŸÎÎŸ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ eligibleUsers ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ Î¼Î­ÏƒÎ±
  const eligLower = elig.map(x=>String(x).toLowerCase());
  const blocked = !!(started && eligLower.length>0 && !eligLower.includes(me));
  if(blocked) return N('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹Ï‚.','err');

  const cur=isLocked(cid,u);
  if(cur){
    setLocked(cid,u,false);
    N('ğŸ”“ ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰ÏƒÎµÏ‚ Ï„Î¹Ï‚ Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï…','ok');
    return render();
  }
  if(!canLockAllPicks(cid,u,matches)){
    return N('â›” Î”ÎµÎ½ ÎºÎ»ÎµÎ¹Î´Ï‰ÏƒÎµÏ‚ Ï€ÏÏŒÎ²Î»ÎµÏˆÎ· Î³Î¹Î± ÏŒÎ»Î± Ï„Î± Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹Î± Ï„Î·Ï‚ Î±Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®Ï‚','err');
  }
  setLocked(cid,u,true);
  N('âœ… ÎšÎ»ÎµÎ¯Î´Ï‰ÏƒÎµÏ‚ Ï„Î¹Ï‚ Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï…','ok');
  render();
}

/* SAVE PICK */
function onSavePick(cid,u,mid){
  const matches=R(K.M,[]);
  const dl=deadlineMsFromMatches(matches);
  if(dl && now()>=dl) return N('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚','err');
  if(isLocked(cid,u)) return N('ğŸ”’ ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ Ï„Î¹Ï‚ Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï…','err');

  const meta = (R(K.META,{})[cid]||{});
  const started = meta.contestStarted===true;
  const elig = Array.isArray(meta.eligibleUsers)?meta.eligibleUsers:[];
  const me = String(u||'').toLowerCase();

  // âœ… FIX: ÎœÏ€Î»Î¿ÎºÎ¬ÏÎµÎ¹ ÎœÎŸÎÎŸ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ eligibleUsers ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ Î¼Î­ÏƒÎ±
  const eligLower = elig.map(x=>String(x).toLowerCase());
  const blocked = !!(started && eligLower.length>0 && !eligLower.includes(me));
  if(blocked) return N('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹Ï‚.','err');

  const m=(matches||[]).find(x=>x && x.id===mid);
  if(m && m.off===true) return N('OFF Î±Î³ÏÎ½Î±Ï‚ (Î±Î½Î±Î²Î¿Î»Î®)','warn');

  const rec=getHelpRec(cid,u);
  const purchased=isHelpPurchased(rec);
  const remaining=Number(rec?.remaining||0);

  if(purchased && remaining>0){
    const w=getWarn(cid,u);
    if(w<2){
      if(!confirm(`Î£Î¿Ï… Î­Î¼ÎµÎ¹Î½Î±Î½ ${remaining} HELP. Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î´ÎµÎ½ Î¸ÎµÏ‚ Î½Î± Ï„Î± Î²Î¬Î»ÎµÎ¹Ï‚;`)) return;
      if(!confirm('Î£Î™Î“ÎŸÎ¥Î¡Î‘;')) return;
      setWarn(cid,u,2);
    }
  }

  const sel=$('sel_'+mid);
  const v=(sel?.value||'').trim();
  if(!v) return N('Î”Î¹Î¬Î»ÎµÎ¾Îµ 1/X/2','warn');

  savePick(cid,u,mid,v);
  N('âœ… ÎˆÎ³Î¹Î½Îµ Save','ok');
  render();
}

function render(){
  const s=sess();
  if(!s) return location.href='login.html';

  $('userPill').textContent='Î§ÏÎ®ÏƒÏ„Î·Ï‚: '+s.username;

  const active=R(K.A,null);
  if(!active){
    $('matches').innerHTML='<div class="pill">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚</div>';
    $('contestInfo').textContent='Contest:-';
    $('roundInfo').textContent='Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®:-';
    $('prizeText').textContent='-';
    $('contestCode').textContent='-';
    $('contestRound').textContent='-';
    $('contestStatus').textContent='-';
    return;
  }

  const cid=active.id;

  const meta=R(K.META,{})[cid]||{};
  $('contestInfo').textContent='Contest: '+cid;
  $('roundInfo').textContent='Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®: '+(meta.round||1);
  $('prizeText').textContent=(String(meta.prizeText||'').trim() || '-');

  $('contestCode').textContent = cid;
  $('contestRound').textContent = (meta.round ?? 1);
  $('contestStatus').textContent = (meta.contestStarted ? 'Î•Î½ÎµÏÎ³ÏŒÏ‚' : 'Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒÏ‚');

  const matches=R(K.M,[]);
  const dl=deadlineMsFromMatches(matches);
  $('dlPill').textContent='Deadline: '+(dl?fmt(dl):'-');

  const timeLocked = (dl && now()>=dl);
  const userLocked = isLocked(cid,s.username);

  const started = meta.contestStarted===true;
  const elig = Array.isArray(meta.eligibleUsers)?meta.eligibleUsers:[];
  const me = String(s.username||'').toLowerCase();

  // âœ… FIX: ÎœÏ€Î»Î¿ÎºÎ¬ÏÎµÎ¹ ÎœÎŸÎÎŸ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ eligibleUsers ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ Î¼Î­ÏƒÎ±
  const eligLower = elig.map(x=>String(x).toLowerCase());
  const blocked = !!(started && eligLower.length>0 && !eligLower.includes(me));

  $('blockedBox').style.display = blocked ? 'block' : 'none';

  const effectiveLocked = blocked || timeLocked || userLocked;

  $('buyBtn').onclick = ()=> goPay();

  const recUI=ensureHelpRec(cid,s.username);
  const purchasedUI=isHelpPurchased(recUI);

  const validMatches = (matches || []).filter(m => m && m.off !== true);
  const noGames = !validMatches.length;

  $('buyBtn').disabled = !!timeLocked || userLocked || purchasedUI || blocked || noGames;

  if(noGames){
    $('helpPill').textContent = 'HELP: â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚';
  }

  const remaining=Number(recUI?.remaining||0);
  const usedCount=Number((recUI?.usedMatchIds||[]).length||0);

  if(!noGames){
    if(!purchasedUI) $('helpPill').textContent='HELP: âŒ (Î´ÎµÎ½ Î±Î³ÏŒÏÎ±ÏƒÎµÏ‚)';
    else $('helpPill').textContent=`HELP: âœ… ${remaining} left â€¢ used ${usedCount}/3`;
  }

  $('lockBtn').textContent = userLocked ? 'ğŸ”“ ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÏ‰Î½' : 'ğŸ”’ ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÏ‰Î½';
  $('lockBtn').onclick = ()=>onLockBtn(cid,s.username,matches);
  $('lockBtn').disabled = !!timeLocked || blocked || noGames;

  $('lockState').textContent =
    'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: ' +
    (blocked ? 'â›” Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹Ï‚ (Î¼Ï€Î®ÎºÎµÏ‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î­Î½Î±ÏÎ¾Î·)'
             : (timeLocked ? 'ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚'
                           : (userLocked?'ğŸ”´ ÎšÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½ÎµÏ‚':'ğŸŸ¢ Î‘Î½Î¿Î¹ÎºÏ„Î­Ï‚')));

  if(timeLocked && !userLocked){
    setAllOff(cid,s.username,matches);
    setLocked(cid,s.username,true);
  }

  const myMap=getMyMap(cid,s.username);

  $('matches').innerHTML = (Array.isArray(matches)&&matches.length)? matches.map(m=>{
    const saved=(myMap?.[m.id]?.pick||'').trim();
    const helpOn = hasHelp(cid,s.username,m.id) || saved==='HELP';
    const off = (m.off===true);

    const canPick = (!effectiveLocked) && (!helpOn) && (!off);
    const lockClass = effectiveLocked ? 'lockedPick' : '';

    const canHelpBtn =
      (!effectiveLocked) && (!off) && purchasedUI && (helpOn || remaining>0);

    return `
    <div class="match ${off?'off':''} ${lockClass}">
      <div><b>${m.home||'?'} vs ${m.away||'?'}</b></div>
      <div class="mini">${m.date||''} ${m.time||''} ${off?'â€¢ OFF (Î±Î½Î±Î²Î¿Î»Î®)':''}</div>

      <div class="row" style="margin-top:8px">
        <select id="sel_${m.id}" ${canPick?'':'disabled'}>
          <option value=""></option>
          <option value="1" ${saved==='1'?'selected':''}>1</option>
          <option value="X" ${saved==='X'?'selected':''}>X</option>
          <option value="2" ${saved==='2'?'selected':''}>2</option>
        </select>

        <button class="btn g" ${canPick?'':'disabled'} onclick="onSavePick('${cid}','${s.username}','${m.id}')">Save</button>

        <button class="btn bl" ${canHelpBtn?'':'disabled'} onclick="toggleHelp('${cid}','${s.username}','${m.id}')">
          ${helpOn?'â†©ï¸ Î‘ÎºÏÏÏ‰ÏƒÎ· HELP':'ğŸª„ HELP'}
        </button>

        <div class="pill">Pick: <b>${saved||'-'}</b></div>
      </div>

      ${m.result?`
        <div class="mini" style="margin-top:8px"><b>Î¤ÎµÎ»Î¹ÎºÏŒ:</b> ${m.result}</div>
        <div class="mini"><b>Î— Ï€ÏÏŒÎ²Î»ÎµÏˆÎ® ÏƒÎ¿Ï…:</b> ${saved||'-'}</div>
      `:''}
    </div>`;
  }).join('') : '<div class="pill">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚ Î±ÎºÏŒÎ¼Î±.</div>';
}

/* expose for inline onclick */
window.onSavePick = onSavePick;
window.toggleHelp = toggleHelp;
window.render = render;
window.CMP = { K, R, W, N, render };

/* notice on return from pay */
(function(){
  const qs = new URLSearchParams(location.search);
  if(qs.get('paid')==='1'){
    N('âœ… Î Î»Î·ÏÏ‰Î¼Î® ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ â€” Î­Ï„Î¿Î¹Î¼Î¿ Ï„Î¿ HELP!','ok');
    history.replaceState({}, document.title, 'dashboard.html');
  }
})();

render();
</script>

<script type="module">
import { supabase } from "./supabase.js";

/* =========================
   PROTECT DASHBOARD (SUPABASE)
========================= */
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  location.replace("login.html");
}

/* âœ… FIX #1: Sync supabase user -> localStorage session + users[] (Î³Î¹Î± Î½Î± Ï„Î¿Î½ Î²Î»Î­Ï€ÎµÎ¹ Î¿ Admin) */
{
  const email = String(session.user.email || "").toLowerCase();
  const username = (email.split("@")[0] || "user").trim();
  const isAdmin = (email === "mariosxixis1980@gmail.com"); // Î²Î¬Î»Îµ ÎµÎ´Ï Ï„Î¿ admin email

  localStorage.setItem("session", JSON.stringify({ username, email, isAdmin }));

  const K_U = "users";
  let arr = [];
  try { arr = JSON.parse(localStorage.getItem(K_U) || "[]"); } catch { arr = []; }
  if(!Array.isArray(arr)) arr = [];

    const idx = arr.findIndex(x =>
    String(x?.email||"").toLowerCase() === email ||
    String(x?.username||"").toLowerCase() === username.toLowerCase()
  );

  const u = { username, email, isAdmin };
  if(idx >= 0) arr[idx] = { ...arr[idx], ...u };
  else arr.push(u);

  localStorage.setItem(K_U, JSON.stringify(arr));
}

/* âœ… Logout: supabase + localStorage */
document.getElementById("lo").addEventListener("click", async () => {
  try { await supabase.auth.signOut(); } catch(e) {}
  localStorage.removeItem("session");
  location.replace("login.html");
});

/* =========================
   âœ… SYNC ACTIVE CONTEST -> localStorage (ÏÏƒÏ„Îµ Î½Î± Î³ÎµÎ¼Î¯Î¶Î¿Ï…Î½ Ï„Î± spans)
========================= */
async function loadActiveContestAndSync(){
  const { K, R, W, N, render } = window.CMP;

  const { data: contests, error: cErr } = await supabase
    .from("contests")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(10);

  if (cErr) {
    console.error("Contest load error:", cErr);
    N("â›” Î ÏÏŒÎ²Î»Î·Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼Î¿Ï", "err");
    return;
  }

  if (!contests || contests.length === 0) {
    W(K.A, null);
    render();
    return;
  }

  const contest = contests.find(x => x && x.active === true) || contests[0];

  // ğŸ”§ contest id Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï€Î±Î½Ï„Î¿Ï (code Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  const cid = (contest.code ?? contest.id ?? contest.contest_code ?? contest.contest_cod ?? "").toString();
  if(!cid){
    N("â›” Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ contest code/id", "err");
    return;
  }

  // Î³ÏÎ¬Ï†Î¿Ï…Î¼Îµ activeContest
  W(K.A, { id: cid });

  // Î³ÏÎ¬Ï†Î¿Ï…Î¼Îµ contestMeta (ÏÏƒÏ„Îµ Î½Î± ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ contestRound/Status/Prize)
  const metaAll = R(K.META, {});
  metaAll[cid] = metaAll[cid] || {};

  // Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î½Î± Ï€Î¬ÏÎ¿Ï…Î¼Îµ Ï„Î± Ï€ÎµÎ´Î¯Î± Î±Ï€ÏŒ supabase (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½)
  const round = (contest.round ?? metaAll[cid].round ?? 1);
  const prizeText = (contest.prize_text ?? contest.prizeText ?? metaAll[cid].prizeText ?? "");
  const started = (contest.active === true); // Î±Î½ Î­Ï‡ÎµÎ¹ active=true, Ï„Î¿ Î¸ÎµÏ‰ÏÎ¿ÏÎ¼Îµ started/ÎµÎ½ÎµÏÎ³ÏŒ

  metaAll[cid] = {
    ...metaAll[cid],
    round: Number(round) || 1,
    prizeText: String(prizeText || ""),
    contestStarted: !!started,
    // âœ… ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ: Î¬ÏƒÎµ eligibleUsers Î¬Î´ÎµÎ¹Î¿ Î±Î½ Î´ÎµÎ½ Î­ÏÏ‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ ÎºÎ¬Ï€Î¿Ï…, Î³Î¹Î± Î½Î± ÎœÎ—Î Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹
    eligibleUsers: Array.isArray(metaAll[cid].eligibleUsers) ? metaAll[cid].eligibleUsers : []
  };

  W(K.META, metaAll);

  render();
}

loadActiveContestAndSync();
</script>

</body>
</html>
