<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <style>
    :root{
      --bg:#070b13; --border:rgba(255,255,255,.12);
      --text:#eaf1ff; --muted:rgba(255,255,255,.65);
      --card1:rgba(255,255,255,.07); --card2:rgba(255,255,255,.04);
      --green:rgba(46,204,113,.20); --greenb:rgba(46,204,113,.45);
      --amber:rgba(241,196,15,.16); --amberb:rgba(241,196,15,.45);
      --red:rgba(231,76,60,.14); --redb:rgba(231,76,60,.45);
      --blue:rgba(52,152,219,.18); --blueb:rgba(52,152,219,.45);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;min-height:100vh;padding:18px;color:var(--text);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(40,110,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(0,255,170,.18), transparent 55%),
        var(--bg);
    }
    .wrap{width:min(1080px,100%);margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card1),var(--card2));
      border:1px solid var(--border);
      border-radius:24px;
      padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      backdrop-filter:blur(10px);
    }
    h1{margin:0;font-size:44px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    .pill{
      display:inline-block;padding:10px 14px;border:1px solid var(--border);
      border-radius:999px;background:rgba(0,0,0,.25);font-weight:800
    }
    button,.btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    /* âœ… FIX: classes Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï‚ ÏƒÏ„Î¿ HTML */
    .green{background:var(--green);border-color:var(--greenb)}
    .amber{background:var(--amber);border-color:var(--amberb)}
    .red{background:var(--red);border-color:var(--redb)}
    .blue{background:var(--blue);border-color:var(--blueb)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
    .box{
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(0,0,0,.18);
      padding:14px;
    }
    .big{font-size:20px;font-weight:950}
    .mini{color:var(--muted);font-weight:750}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;text-align:left}
    th{color:var(--muted)}
    .hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0}
    .tag{
      display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);font-weight:900;font-size:12px;
    }
    .tagOn{background:var(--green);border-color:var(--greenb)}
    .tagOff{background:var(--red);border-color:var(--redb)}
    .tagRes{background:var(--blue);border-color:var(--blueb)}
    .tagNo{background:rgba(255,255,255,.06)}
    .tagOk{background:var(--green);border-color:var(--greenb)}
    .tagBad{background:var(--red);border-color:var(--redb)}
    .tagHelp{background:var(--blue);border-color:var(--blueb)}
    .tagWait{background:var(--amber);border-color:var(--amberb)}
    .muted{color:var(--muted)}

    /* âœ… Winner Card (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿Î½ Î¯Î´Î¹Î¿ Ï„Î¿Î½ Î½Î¹ÎºÎ·Ï„Î®) */
    .winnerCard{
      margin-top:12px;
      border:1px solid rgba(241,196,15,.55);
      background:rgba(241,196,15,.18);
      border-radius:22px;
      padding:16px;
      text-align:center;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
    }
    .winnerTitle{font-size:22px;font-weight:950}
    .winnerMini{margin-top:6px;font-weight:800;color:rgba(255,255,255,.78)}

    /* âœ… NEW: nicer "My Scores" layout */
    .scoreGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (min-width:720px){
      .scoreGrid{ grid-template-columns:1fr 1fr 1fr; }
    }
    .scoreCard{
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      border-radius:18px;
      padding:12px;
      min-height:78px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .scoreLabel{color:var(--muted);font-weight:850;font-size:12px;letter-spacing:.2px}
    .scoreValue{font-size:26px;font-weight:1000;line-height:1.1;margin-top:6px}
    .scoreHint{color:rgba(255,255,255,.75);font-weight:850;font-size:12px;margin-top:6px}
    .scoreCard.green{background:linear-gradient(180deg, rgba(46,204,113,.16), rgba(0,0,0,.20));border-color:var(--greenb)}
    .scoreCard.blue{background:linear-gradient(180deg, rgba(52,152,219,.16), rgba(0,0,0,.20));border-color:var(--blueb)}
    .scoreCard.amber{background:linear-gradient(180deg, rgba(241,196,15,.14), rgba(0,0,0,.20));border-color:var(--amberb)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ† Leaderboard</h1>
      <div class="sub">Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Î²Î±Î¸Î¼Î¿ÏÏ‚, ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î±Î³ÏÎ½Ï‰Î½, Î±Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ® ÎºÎ±Î¹ Î²ÏÎ±Î²ÎµÎ¯Î¿.</div>

      <div class="row">
        <a class="btn" href="dashboard.html">â† Dashboard</a>
        <a class="btn" id="adminBtn" href="admin.html" style="display:none;">ğŸ›  Admin</a>
        <div class="pill" id="userPill">Î§ÏÎ®ÏƒÏ„Î·Ï‚: -</div>
        <div class="pill" id="contestPill">Contest: -</div>
        <button class="btn" id="refreshBtn" type="button">â†» Refresh</button>
      </div>

      <div class="row">
        <div class="pill" id="contestActivePill">Î•Î½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: -</div>
        <div class="pill" id="roundPill">Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®: -</div>
      </div>

      <!-- âœ… Final Week & Admin Winner pills -->
      <div class="row" style="margin-top:12px">
        <div class="pill amber" id="finalWeekPill" style="display:none;">ğŸ Final Week - Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®</div>
        <div class="pill blue" id="winnerPill" style="display:none;">ğŸ† ÎÎ¹ÎºÎ·Ï„Î®Ï‚: -</div>
      </div>

      <!-- âœ… Winner Card placeholder (ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î¿Î½ Î½Î¹ÎºÎ·Ï„Î®) -->
      <div id="winnerCard"></div>

      <div class="box" style="margin-top:12px">
        <div class="big">ğŸ Î’ÏÎ±Î²ÎµÎ¯Î¿ ÎÎ¹ÎºÎ·Ï„Î®</div>
        <div class="mini" id="prizeText">-</div>
      </div>

      <div class="grid" id="myGrid">
        <div class="box">
          <div class="big">ğŸ‘¤ ÎŸÎ¹ Î²Î±Î¸Î¼Î¿Î¯ Î¼Î¿Ï…</div>
          <div class="mini" style="margin-top:6px">
            <b>Live Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®Ï‚</b> = Î±Ï€ÏŒ Ï„Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± matches (ÏŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Î® OFF/HELP).<br/>
            <b>Contest</b> = ÏƒÏÎ½Î¿Î»Î¿ ÏƒÏ„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ contest (Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Â«ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î¤ÎµÎ»Î¹ÎºÏÎ½Â»).<br/>
            <b>Î£ÏÎ½Î¿Î»Î¿</b> = Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ contests (Î¼Î­Ï‡ÏÎ¹ RESET).
          </div>

          <div class="scoreGrid">
            <div class="scoreCard blue">
              <div class="scoreLabel">âš¡ LIVE Î‘Î“Î©ÎÎ™Î£Î¤Î™ÎšÎ—Î£</div>
              <div class="scoreValue" id="myRoundPts">-</div>
              <div class="scoreHint">Î¤ÏÏÎ± / Î±Ï…Ï„Î® Î· Î±Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®</div>
            </div>

            <div class="scoreCard green">
              <div class="scoreLabel">ğŸ Î£Î¥ÎÎŸÎ›ÎŸ CONTEST</div>
              <div class="scoreValue" id="myContestPts">-</div>
              <div class="scoreHint" id="myContestRank">Î˜Î­ÏƒÎ· (Contest): -</div>
            </div>

            <div class="scoreCard amber">
              <div class="scoreLabel">ğŸŒ Î“Î•ÎÎ™ÎšÎŸ Î£Î¥ÎÎŸÎ›ÎŸ</div>
              <div class="scoreValue" id="myTotalPts">-</div>
              <div class="scoreHint" id="myTotalRank">Î˜Î­ÏƒÎ· (Î£ÏÎ½Î¿Î»Î¿): -</div>
            </div>
          </div>

          <hr class="hr"/>

          <div class="big">ğŸ§¾ Breakdown (Live)</div>
          <div class="mini">Î£Ï‰ÏƒÏ„Î¬, HELP, OFF-HELP, BONUS.</div>

          <div id="breakdown" class="mini" style="margin-top:10px"></div>

          <div class="mini" style="margin-top:10px">
            * Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„ÎµÎ»Î¹ÎºÎ¬ Î±ÎºÏŒÎ¼Î±, Ï„Î¿ Live Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¼Î¹ÎºÏÏŒ/0.
          </div>
        </div>

        <div class="box">
          <div class="big">ğŸ“Œ ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î±Î³ÏÎ½Ï‰Î½</div>
          <div class="mini">ON = Î¼ÎµÏ„ÏÎ¬ÎµÎ¹. OFF = Î±Î½Î±Î²Î»Î®Î¸Î·ÎºÎµ. Î‘Î½ ÎµÎ¯Ï‡ÎµÏ‚ HELP ÏƒÎµ OFF, ÎºÏÎ±Ï„Î¬Ï‚ Ï„Î¿Î½ 1 Î²Î±Î¸Î¼ÏŒ.</div>
          <div id="matchesBox" style="margin-top:12px"></div>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="row" style="margin-top:0">
          <div class="pill" id="playersCount">Î Î±Î¯ÎºÏ„ÎµÏ‚: -</div>
        </div>
        <table>
          <thead>
            <tr><th>#</th><th>Î Î±Î¯ÎºÏ„Î·Ï‚</th><th>Contest</th><th>Î£ÏÎ½Î¿Î»Î¿</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
  import { supabase } from "./supabase.js";
  (async ()=>{
    try{
      const { data: { session } } = await supabase.auth.getSession();
      if(!session) return; // Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ logged-in, Ï„Î¿ normal guard Î¸Î± ÏƒÎµ ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ login

      // Ï€Î¬ÏÎµ Ï„Î¿ Ï€Î¹Î¿ Ï€ÏÏŒÏƒÏ†Î±Ï„Î¿ published+active contest
      const { data: contests, error } = await supabase
        .from('contests')
        .select('code, round, active, published, meta, matches, created_at')
        .eq('published', true)
        .eq('active', true)
        .order('created_at', { ascending:false })
        .limit(1);
      if(error) return;
      const c = (contests && contests[0]) ? contests[0] : null;
      if(!c) return;

      const cid = String(c.code || '').trim();
      if(!cid) return;
      localStorage.setItem('activeContest', JSON.stringify({ id: cid }));

      // meta + matches (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ„Î®Î»ÎµÏ‚)
      const metaAll = (()=>{ try{return JSON.parse(localStorage.getItem('contestMeta')||'{}')}catch{ return {} } })();
      metaAll[cid] = (c.meta && typeof c.meta === 'object') ? c.meta : (metaAll[cid]||{});
      if(c.round != null) metaAll[cid] = { ...metaAll[cid], round: c.round };
      metaAll[cid] = { ...metaAll[cid], published:true, contestStarted:true };
      localStorage.setItem('contestMeta', JSON.stringify(metaAll));

      if(Array.isArray(c.matches)) localStorage.setItem('contestMatches', JSON.stringify(c.matches));
    }catch(e){}
  })();
  </script>

  <script>
const KEY_SESSION='session',
      KEY_ACTIVE='activeContest',
      KEY_MATCHES='contestMatches',
      KEY_PICKS='picks',
      KEY_SCORES_TOTAL='scores',
      KEY_SCORES_BY_CONTEST='scoresByContest',
      KEY_META='contestMeta',
      KEY_TIE_STATS='tieStatsByContest';

const $=id=>document.getElementById(id);
function readJSON(k,f){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(f)); }catch(e){ return f; } }
function writeJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function getSession(){ const s=readJSON(KEY_SESSION,null); return (s&&s.username)?s:null; }
function isAdminSession(s){ if(!s) return false; if(s.isAdmin===true) return true; return String(s.username||'').toLowerCase()==='marios'; }

function fmtDateTime(iso){
  const t=new Date(iso).getTime(); if(!Number.isFinite(t)) return '-';
  const d=new Date(t),
        dd=String(d.getDate()).padStart(2,'0'),
        mm=String(d.getMonth()+1).padStart(2,'0'),
        yy=d.getFullYear(),
        hh=String(d.getHours()).padStart(2,'0'),
        mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yy} ${hh}:${mi}`;
}
function fmtDateShort(iso){
  const t=new Date(iso).getTime(); if(!Number.isFinite(t)) return '-';
  const d=new Date(t),
        dd=String(d.getDate()).padStart(2,'0'),
        mm=String(d.getMonth()+1).padStart(2,'0'),
        yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function getMetaForContest(contestId){
  const all=readJSON(KEY_META,{});
  return (all&&typeof all==='object')?(all[contestId]||null):null;
}

/* Tie Stats */
function getTieStats(cid){
  const all=readJSON(KEY_TIE_STATS,{});
  if(!all || typeof all!=='object') return {};
  return all[cid] && typeof all[cid]==='object' ? all[cid] : {};
}

/* âœ… NEW: Live points for CURRENT ROUND (from matches+picks, not from scoresByContest) */
function computeLiveRoundPointsForUser(username, contestId){
  const matches=readJSON(KEY_MATCHES,[]);
  const allPicks=readJSON(KEY_PICKS,{});
  const cp=(allPicks&&allPicks[contestId])?allPicks[contestId]:{};
  const map=cp[username]||{};

  let pts=0, req=0, ok=0;

  for(const m of matches){
    const pick=(map?.[m.id]?.pick||'').trim();

    if(m.off===true){
      // OFF: Î±Î½ ÎµÎ¯Ï‡Îµ HELP Ï€Î±Î¯ÏÎ½ÎµÎ¹ +1
      if(pick==='HELP'){ pts+=1; }
      continue;
    }

    // ON: Î¼ÎµÏ„ÏÎ¬ÎµÎ¹ Î¼ÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„ÎµÎ»Î¹ÎºÏŒ
    const res=(m.result||'').trim();
    if(!res) continue;

    req++;

    if(pick==='HELP'){ pts+=1; ok+=1; continue; }
    if(pick && pick===res){ pts+=1; ok+=1; }
  }

  // BONUS +2 Î±Î½ ÏƒÏ„Î± Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹Î± Ï€Î¿Ï… ÎµÎ¯Ï‡Î±Î½ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± (ON), Ï„Î± Ï€Î­Ï„Ï…Ï‡ÎµÏ‚ ÏŒÎ»Î± (HELP=ok)
  if(req>0 && ok===req) pts+=2;

  return pts;
}

function computeBreakdownForUser(username, contestId){
  const matches=readJSON(KEY_MATCHES,[]);
  const allPicks=readJSON(KEY_PICKS,{});
  const cp=(allPicks&&allPicks[contestId])?allPicks[contestId]:{};
  const map=cp[username]||{};

  let correct=0, help=0, offHelp=0, req=0, ok=0;

  for(const m of matches){
    const pick=(map?.[m.id]?.pick||'').trim();

    if(m.off===true){
      if(pick==='HELP'){ offHelp+=1; help+=1; }
      continue;
    }

    const res=(m.result||'').trim();
    if(!res) continue;

    req++;

    if(pick==='HELP'){ help+=1; ok+=1; continue; }
    if(pick && pick===res){ correct+=1; ok+=1; }
  }

  const bonus = (req>0 && ok===req) ? 2 : 0;
  return {correct,help,offHelp,required:req,bonus};
}

function calcRanks(list, username){
  const sorted=list.slice().sort((a,b)=>(b.pts-a.pts)||a.u.localeCompare(b.u));
  const idx=sorted.findIndex(x=>x.u===username);
  return { rank: idx>=0?(idx+1):null, totalPlayers: sorted.length, sorted };
}

function pickStatus(match, myPick){
  const off = match.off===true;
  const res = (match.result||'').trim();
  const p = (myPick||'').trim();
  if(off) return {text:'OFF', cls:'tagOff'};
  if(!p) return {text:'Î§Î©Î¡Î™Î£ PICK', cls:'tagNo'};
  if(p==='HELP') return {text:'HELP', cls:'tagHelp'};
  if(!res) return {text:'Î‘ÎÎ‘ÎœÎŸÎÎ—', cls:'tagWait'};
  if(p===res) return {text:'Î£Î©Î£Î¤ÎŸ', cls:'tagOk'};
  return {text:'Î›Î‘Î˜ÎŸÎ£', cls:'tagBad'};
}

/* Final Week sorting + silent lottery */
function sortByFinalRules(merged, cid, meta){
  const finalWeek = meta?.finalWeek===true;
  if(!finalWeek) {
    return merged.slice().sort((a,b)=>(b.total-a.total)||a.u.localeCompare(b.u));
  }

  const tieStats = getTieStats(cid);

  const withTB = merged.map(x=>{
    const st = tieStats?.[x.u] || {};
    return {
      ...x,
      tb1: Number(st.bonusCount||0),
      tb2: Number(st.bonusStreakMax||0),
      tb3: Number(st.nearPerfectCount||0),
    };
  });

  withTB.sort((a,b)=>
    (b.total-a.total) ||
    (b.tb1-a.tb1) ||
    (b.tb2-a.tb2) ||
    (b.tb3-a.tb3) ||
    a.u.localeCompare(b.u)
  );

  if(withTB.length<2) return withTB;

  const top = withTB[0];
  const tied = withTB.filter(x =>
    x.total===top.total &&
    x.tb1===top.tb1 &&
    x.tb2===top.tb2 &&
    x.tb3===top.tb3
  );

  if(tied.length<=1) return withTB;

  let finalWinner = String(meta?.finalWinner||'').trim();
  if(finalWinner && tied.some(x=>x.u===finalWinner)){
    // ok
  } else {
    const pick = tied[Math.floor(Math.random()*tied.length)].u;
    finalWinner = pick;

    const allMeta = readJSON(KEY_META,{});
    allMeta[cid] = allMeta[cid] || {};
    allMeta[cid].finalWinner = finalWinner;
    allMeta[cid].finalWinnerAt = Date.now();
    writeJSON(KEY_META, allMeta);
  }

  const winnerFirst = withTB.slice().sort((a,b)=>{
    const aw = (a.u===finalWinner)?1:0;
    const bw = (b.u===finalWinner)?1:0;
    if(aw!==bw) return bw-aw;

    return (b.total-a.total) ||
      (b.tb1-a.tb1) ||
      (b.tb2-a.tb2) ||
      (b.tb3-a.tb3) ||
      a.u.localeCompare(b.u);
  });

  return winnerFirst;
}

function render(){
  const sess=getSession();
  if(!sess){ location.href="login.html"; return; }

  const isAdmin=isAdminSession(sess);

  $('userPill').textContent='Î§ÏÎ®ÏƒÏ„Î·Ï‚: '+sess.username;
  $('adminBtn').style.display=isAdmin?'inline-flex':'none';
  $('myGrid').style.display = isAdmin ? 'none' : 'grid';

  const active=readJSON(KEY_ACTIVE,null);
  const cid=active?.id||'-';
  $('contestPill').textContent='Contest: '+cid;

  let meta = null;

  // reset pills/cards
  const fwPill = $('finalWeekPill');
  const winPill = $('winnerPill');
  const wc = $('winnerCard');
  if(fwPill){ fwPill.style.display='none'; }
  if(winPill){ winPill.style.display='none'; winPill.textContent='ğŸ† ÎÎ¹ÎºÎ·Ï„Î®Ï‚: -'; }
  if(wc){ wc.innerHTML=''; }

  if(cid==='-'){
    $('contestActivePill').textContent='Î•Î½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: -';
    $('roundPill').textContent='Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®: -';
    $('prizeText').textContent='-';
  }else{
    meta=getMetaForContest(cid);
    const round=Number(meta?.round||1);
    $('roundPill').textContent='Î‘Î³Ï‰Î½Î¹ÏƒÏ„Î¹ÎºÎ®: '+round;

    const started = meta?.contestStarted===true;
    $('contestActivePill').textContent = started ? 'Î•Î½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: âœ…' : 'Î•Î½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: â³ (Î´ÎµÎ½ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ)';

    const ends=meta?.contestEndsAtISO?fmtDateShort(meta.contestEndsAtISO):null;
    if(ends) $('contestActivePill').textContent += ' â€¢ Î¼Î­Ï‡ÏÎ¹ '+ends;

    const ptxt=String(meta?.prizeText||'').trim();
    $('prizeText').textContent=ptxt?ptxt:'Î”ÎµÎ½ Î±Î½Î±ÎºÎ¿Î¹Î½ÏÎ¸Î·ÎºÎµ Î±ÎºÏŒÎ¼Î±.';

    // Final Week pill (Î³Î¹Î± ÎŸÎ›ÎŸÎ¥Î£)
    if(fwPill && meta?.finalWeek===true){
      fwPill.style.display='inline-block';
    }
  }

  const scoresTotal=readJSON(KEY_SCORES_TOTAL,{});
  const scoresByContest=readJSON(KEY_SCORES_BY_CONTEST,{});
  const perContest=(cid!=='-' && scoresByContest && scoresByContest[cid])?scoresByContest[cid]:{};

  if(!isAdmin){
    // âœ… Live current round points (from matches/picks)
    const myRoundPts = (cid==='-') ? 0 : computeLiveRoundPointsForUser(sess.username, cid);

    // âœ… Contest + Total (stored)
    const myContestPts=Number(perContest?.[sess.username] ?? 0);
    const myTotalPts=Number(scoresTotal?.[sess.username] ?? 0);

    $('myRoundPts').textContent=String(myRoundPts);
    $('myContestPts').textContent=String(myContestPts);
    $('myTotalPts').textContent=String(myTotalPts);

    const contestList=Object.entries(perContest||{}).map(([u,pts])=>({u,pts:Number(pts)||0}));
    const totalList=Object.entries(scoresTotal||{}).map(([u,pts])=>({u,pts:Number(pts)||0}));
    const rC=calcRanks(contestList,sess.username);
    const rT=calcRanks(totalList,sess.username);
    $('myContestRank').textContent='Î˜Î­ÏƒÎ· (Contest): '+(rC.rank ?? '-');
    $('myTotalRank').textContent='Î˜Î­ÏƒÎ· (Î£ÏÎ½Î¿Î»Î¿): '+(rT.rank ?? '-');

    if(cid==='-'){
      $('breakdown').innerHTML=`<div class="pill">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³ÏŒÏ‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚.</div>`;
    }else{
      const b=computeBreakdownForUser(sess.username,cid);
      $('breakdown').innerHTML=`
        <div class="row" style="margin-top:0">
          <div class="pill green">Î£Ï‰ÏƒÏ„Î¬: ${b.correct}</div>
          <div class="pill blue">HELP: ${b.help}</div>
          <div class="pill red">OFF-HELP: ${b.offHelp}</div>
          <div class="pill amber">BONUS: +${b.bonus}</div>
        </div>
        <div class="mini" style="margin-top:8px">
          Î‘Î³ÏÎ½ÎµÏ‚ Î¼Îµ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± (ON) Î³Î¹Î± bonus: <b>${b.required}</b>
        </div>
      `;
    }
  }

  const allUsers=Array.from(new Set([
    ...Object.keys(scoresTotal||{}),
    ...Object.keys(perContest||{})
  ])).sort((a,b)=>a.localeCompare(b));

  const mergedBase=allUsers.map(u=>({
    u,
    contest:Number(perContest?.[u]??0),
    total:Number(scoresTotal?.[u]??0)
  }));

  const merged = (cid!=='-' ? sortByFinalRules(mergedBase, cid, meta)
                            : mergedBase.slice().sort((a,b)=>(b.total-a.total)||a.u.localeCompare(b.u)));

  // Winner logic
  const winnerUsername = (merged && merged.length) ? merged[0].u : null;
  const isFinalWeek = meta?.finalWeek===true;
  const resultsLocked = meta?.resultsLocked===true;

  // Admin-only pill
  if(winPill){
    if(isAdmin && cid!=='-' && isFinalWeek && resultsLocked && winnerUsername){
      winPill.style.display='inline-block';
      winPill.textContent='ğŸ† ÎÎ¹ÎºÎ·Ï„Î®Ï‚: ' + winnerUsername;
    } else {
      winPill.style.display='none';
    }
  }

  // Winner card only for winner
  if(wc){
    if(cid!=='-' && isFinalWeek && resultsLocked && winnerUsername && String(sess.username)===String(winnerUsername)){
      wc.innerHTML = `
        <div class="winnerCard">
          <div class="winnerTitle">ğŸ† Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î±!</div>
          <div class="winnerMini">Î•Î¯ÏƒÎ±Î¹ Î¿ Î½Î¹ÎºÎ·Ï„Î®Ï‚ Ï„Î¿Ï… Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼Î¿Ï ğŸ‰</div>
        </div>
      `;
    } else {
      wc.innerHTML = '';
    }
  }

  $('playersCount').textContent='Î Î±Î¯ÎºÏ„ÎµÏ‚: '+merged.length;
  $('rows').innerHTML=merged.map((x,i)=>{
    const me=(x.u===sess.username);
    return `<tr>
      <td><b>${i+1}</b></td>
      <td>${escapeHtml(x.u)}${me?' <span class="muted">(ÎµÏƒÏ)</span>':''}</td>
      <td><b>${x.contest}</b></td>
      <td><b>${x.total}</b></td>
    </tr>`;
  }).join('');

  const matches=readJSON(KEY_MATCHES,[]);
  const allPicks=readJSON(KEY_PICKS,{});
  const myMap=(cid!=='-' && allPicks?.[cid]?.[sess.username])?allPicks[cid][sess.username]:{};

if(!Array.isArray(matches) || !matches.length){
    $('matchesBox').innerHTML=`<div class="pill">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚ Î±ÎºÏŒÎ¼Î±.</div>`;
  }else{
    $('matchesBox').innerHTML=matches.map((m,idx)=>{
      const off=(m.off===true);
      const res=(m.result||'').trim();
      const when=m.startISO?fmtDateTime(m.startISO):'-';
      const title=`${escapeHtml(m.home||'?')} vs ${escapeHtml(m.away||'?')}`;
      const myPick=(myMap?.[m.id]?.pick || '').trim();
      const myPickLabel=myPick?escapeHtml(myPick):'-';
      const st=pickStatus(m,myPick);

      return `
        <div class="box" style="padding:12px;margin-top:10px;${off?'opacity:.85;background:rgba(0,0,0,.35)':''}">
          <div class="row" style="margin-top:0;justify-content:space-between">
            <div style="font-weight:950">${idx+1}. ${title}</div>
            <div>
              <span class="tag ${off?'tagOff':'tagOn'}">${off?'OFF / Î‘Î½Î±Î²Î¿Î»Î®':'ON'}</span>
              <span class="tag ${res?'tagRes':'tagNo'}">${res?('Î¤ÎµÎ»Î¹ÎºÏŒ: '+escapeHtml(res)):'Î¤ÎµÎ»Î¹ÎºÏŒ: -'}</span>
            </div>
          </div>
          <div class="mini">ğŸ•’ ${when}</div>
          <div class="mini" style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span><b>Î— Ï€ÏÏŒÎ²Î»ÎµÏˆÎ® ÏƒÎ¿Ï…:</b> ${myPickLabel}</span>
            <span class="tag ${st.cls}">${st.text}</span>
          </div>
        </div>
      `;
    }).join('');
  }
}

$('refreshBtn').addEventListener('click', render);
render();
</script>
</body>
</html>