<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reset Password</title>
  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0b1220;
      color:#eaf1ff;
      font-family:system-ui,Segoe UI,Arial;
    }
    .card{
      width:min(420px,100%);
      background:#121a2f;
      border-radius:16px;
      padding:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    h2{margin-top:0}
    input{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      margin-top:10px;
      font-size:16px;
    }
    button{
      margin-top:12px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#2ecc71;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .msg{margin-top:10px;font-weight:700}
  </style>
</head>

<body>
  <div class="card">
    <h2>ğŸ”‘ ÎÎ­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚</h2>
    <p>Î’Î¬Î»Îµ Î½Î­Î¿ password ÎºÎ±Î¹ Ï€Î¬Ï„Î± Î±Î»Î»Î±Î³Î®.</p>

    <input id="newPass" type="password" placeholder="ÎÎ­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚"/>
    <button id="saveBtn">Î‘Î»Î»Î±Î³Î® ÎºÏ‰Î´Î¹ÎºÎ¿Ï</button>

    <div id="msg" class="msg"></div>
  </div>

  <script type="module">
    import { supabase } from "./supabase.js";

    const msg = document.getElementById("msg");
    const passInput = document.getElementById("newPass");

    
    // 1ï¸âƒ£ Î Î™Î‘ÎÎŸÎ¥ÎœÎ• SESSION Î‘Î ÎŸ Î¤ÎŸ URL (ÎÎ•ÎŸ: code=..., Î Î‘Î›Î™ÎŸ: #access_token=...)
    const qs = new URLSearchParams(location.search);
    const code = qs.get("code");

    if(code){
      // ÎÎ­Î± ÏÎ¿Î® Supabase (PKCE / code exchange)
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if(error){
        msg.textContent = "âŒ Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î±Î½Î¿Î¯Î¾Ï‰ session Î±Ï€ÏŒ Ï„Î¿ link. Î†Î½Î¿Î¹Î¾Îµ Î¾Î±Î½Î¬ Ï„Î¿ email link.";
        msg.style.color = "#ffb3b3";
      }
    }else{
      // Î Î±Î»Î¹Î¬ ÏÎ¿Î® (tokens ÏƒÏ„Î¿ hash)
      const hash = new URLSearchParams(location.hash.substring(1));
      const access_token = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");

      if(!access_token || !refresh_token){
        msg.textContent = "âŒ Î›ÎµÎ¯Ï€ÎµÎ¹ auth session. Î†Î½Î¿Î¹Î¾Îµ Î¾Î±Î½Î¬ Ï„Î¿ link Î±Ï€ÏŒ Ï„Î¿ email.";
        msg.style.color = "#ffb3b3";
      }else{
        await supabase.auth.setSession({ access_token, refresh_token });
      }
    }


    // 2ï¸âƒ£ Î‘Î›Î›Î‘Î“Î— PASSWORD
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const password = passInput.value.trim();
      if(password.length < 6){
        msg.textContent = "âŒ Î¤Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 6 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.";
        msg.style.color = "#ffb3b3";
        return;
      }

      const { error } = await supabase.auth.updateUser({ password });
      if(error){
        msg.textContent = "âŒ " + error.message;
        msg.style.color = "#ffb3b3";
        return;
      }

      msg.textContent = "âœ… ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î¬Î»Î»Î±Î¾Îµ! ÎœÎµÏ„Î±Ï†Î­ÏÎµÏƒÎ±Î¹ ÏƒÏ„Î¿ login...";
      msg.style.color = "#7CFFB2";

      try { await supabase.auth.signOut(); } catch(e) {}
      try { localStorage.removeItem("session"); } catch(e) {}
      setTimeout(() => {
        location.replace("login.html");
      }, 700);
    });
  </script>
</body>
</html>
