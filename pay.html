<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Î Î»Î·ÏÏ‰Î¼Î® â‚¬1,99</title>
<style>
:root{
  --bg:#070b13;--b:rgba(255,255,255,.12);
  --t:#eaf1ff;--m:rgba(255,255,255,.65);
  --g:rgba(46,204,113,.20);--a:rgba(241,196,15,.16);--r:rgba(231,76,60,.14);--bl:rgba(52,152,219,.18);
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{margin:0;min-height:100vh;padding:14px;color:var(--t);
background:
radial-gradient(900px 700px at 20% 0%,rgba(40,110,255,.25),transparent 55%),
radial-gradient(900px 700px at 80% 10%,rgba(0,255,170,.18),transparent 55%),
var(--bg)}
.card{max-width:840px;margin:0 auto;border:1px solid var(--b);border-radius:18px;padding:14px;
background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.04));
box-shadow:0 18px 60px rgba(0,0,0,.55)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.box{border:1px solid var(--b);border-radius:16px;background:rgba(0,0,0,.18);padding:12px;margin-top:12px}
.pill{padding:8px 12px;border:1px solid var(--b);border-radius:999px;background:rgba(0,0,0,.25);font-weight:800}
.btn{border:1px solid var(--b);background:rgba(255,255,255,.06);color:var(--t);
padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn:disabled{opacity:.55;cursor:not-allowed}
.g{background:var(--g)} .a{background:var(--a)} .r{background:var(--r)} .bl{background:var(--bl)}
.mini{color:var(--m);font-weight:750}
code{background:rgba(0,0,0,.35);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 12px;border-radius:999px;
border:1px solid var(--b);background:rgba(0,0,0,.55);display:none;z-index:9999;max-width:min(92vw,760px);text-align:center}
</style>
</head>
<body>

<div class="card">
  <h1 style="margin:0;font-size:40px">ğŸ’¶ Î Î»Î·ÏÏ‰Î¼Î® â‚¬1,99</h1>
  <div class="mini" style="margin-top:6px">
    Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ <b>TEST MODE</b>. Î£Ï„Î¿ Ï„Î­Î»Î¿Ï‚ Ï„Î¿ ÎºÎ¬Î½Î¿Ï…Î¼Îµ ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒ (Stripe/PayPal).
  </div>

  <div class="box">
    <div class="pill">ğŸ“Œ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</div>
    <div class="mini" id="info" style="margin-top:8px">-</div>
  </div>

  <div class="box">
    <div class="pill">âœ… Î ÏÏ‚ Ï€Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ (TEST)</div>
    <div class="mini" style="margin-top:8px;line-height:1.6">
      1) Î£Ï„ÎµÎ¯Î»Îµ <b>â‚¬1,99</b> Î¼Îµ ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·: <code id="note">HELP</code><br/>
      2) ÎœÎ­Î¸Î¿Î´Î¿Ï‚: <b>Revolut / PayPal / IBAN</b> (Î²Î¬Î»Îµ Î´Î¹ÎºÎ¬ ÏƒÎ¿Ï… ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±)<br/>
      3) ÎœÎµÏ„Î¬ Ï€Î¬Ï„Î± <b>â€œÎ Î»Î®ÏÏ‰ÏƒÎ±â€</b> Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Ï„Î± 3 HELP.
    </div>
  </div>

  <div class="row">
    <a class="btn" href="dashboard.html">â† Î Î¯ÏƒÏ‰</a>
    <button class="btn r" id="cancel" type="button">Î†ÎºÏ…ÏÎ¿</button>
    <button class="btn g" id="paid" type="button">âœ… Î Î»Î®ÏÏ‰ÏƒÎ±</button>
  </div>

  <div class="box">
    <div class="mini" id="guardMsg">
      ÎœÎµ Ï„Î¿ â€œÎ Î»Î®ÏÏ‰ÏƒÎ±â€ Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬ HELP ÏƒÏ„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒ (3 HELP) Î³Î¹Î± Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· ÏƒÎ¿Ï….
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const K={
  S:'session',
  A:'activeContest',
  H:'help199',
  M:'contestMatches',
  META:'contestMeta',
  LOCK:'picksLocked'
};
const $=id=>document.getElementById(id);
const R=(k,f)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(f))}catch{return f}};
const W=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const now=()=>Date.now();
const T=m=>{const x=$('toast');x.textContent=m;x.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>x.style.display='none',2300)};

/* helpers */
function isValidEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); } // (Î´ÎµÎ½ Ï„Î¿ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Ï…Î¼Îµ ÎµÎ´Ï, Î±Ï€Î»Î¬ safe)

function deadlineMsFromMatches(arr){
  const times=(arr||[])
    .filter(m=>m && m.off!==true)
    .map(m=>new Date(m.startISO).getTime())
    .filter(Number.isFinite);
  if(!times.length) return null;
  return Math.min(...times)-10*60*1000;
}

function lockAll(){ return R(K.LOCK,{}); }
function isLocked(cid,u){ return !!(lockAll()?.[cid]?.[u]); }

function ensureHelpRec(cid,u){
  const all=R(K.H,{});
  all[cid]=all[cid]||{};
  all[cid][u]=all[cid][u]||{paidAt:null,remaining:0,usedMatchIds:[]};
  all[cid][u].remaining = Number(all[cid][u].remaining||0);
  all[cid][u].usedMatchIds = Array.isArray(all[cid][u].usedMatchIds)?all[cid][u].usedMatchIds:[];
  W(K.H,all);
  return all[cid][u];
}

/* âœ… GUARD: Î¿Î¹ Î¯Î´Î¹ÎµÏ‚ Ï€ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚ Î¼Îµ dashboard */
function computeGuards(){
  const s=R(K.S,null);
  const active=R(K.A,null);
  const cid=active?.id;

  const matches=R(K.M,[]);
  const validMatches=(matches||[]).filter(m=>m && m.off !== true);
  const noGames = !validMatches.length;

  const dl = deadlineMsFromMatches(matches);
  const timeLocked = (dl && now()>=dl);

  const userLocked = (s && cid) ? isLocked(cid, s.username) : false;

  const meta = (cid ? (R(K.META,{})[cid]||{}) : {});
  const started = meta.contestStarted === true;
  const elig = Array.isArray(meta.eligibleUsers) ? meta.eligibleUsers : [];
  const me = String(s?.username||'').toLowerCase();
  const blocked = !!(started && !elig.map(x=>String(x).toLowerCase()).includes(me));

  return { s, active, cid, matches, validMatches, noGames, dl, timeLocked, userLocked, blocked };
}

(function main(){
  const g = computeGuards();

  if(!g.s) return location.href='login.html';
  if(!g.cid) return location.href='dashboard.html';

  $('info').innerHTML = `User: <b>${g.s.username}</b> â€¢ Contest: <b>${g.cid}</b> â€¢ Î¤Î¹Î¼Î®: <b>â‚¬1,99</b>`;
  $('note').textContent = `HELP ${g.cid} ${g.s.username}`;

  $('cancel').onclick=()=>location.href='dashboard.html';

  function disablePay(reason){
    $('paid').disabled = true;
    $('guardMsg').innerHTML = reason;
  }

  // âœ… Î‘Ï€Î±Î³Î¿ÏÎµÏÏƒÎµÎ¹Ï‚
  if(g.noGames){
    disablePay('â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚ (Î® ÏŒÎ»Î¿Î¹ ÎµÎ¯Î½Î±Î¹ OFF). Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÎ¹Ï‚ Ï„ÏÏÎ±.');
  } else if(g.blocked){
    disablePay('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÎ¹Ï‚.');
  } else if(g.timeLocked){
    disablePay('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ (deadline) â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬.');
  } else if(g.userLocked){
    disablePay('ğŸ”’ ÎˆÏ‡ÎµÎ¹Ï‚ Î®Î´Î· ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ Ï„Î¹Ï‚ Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï… â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬.');
  }

  $('paid').onclick=()=>{
    // Î¾Î±Î½Î±-check Ï€ÏÎ¹Î½ Î³ÏÎ¬ÏˆÎµÎ¹ paidAt (Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±)
    const gg = computeGuards();
    if(gg.noGames) return T('â›” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³ÏÎ½ÎµÏ‚.');
    if(gg.blocked) return T('â›” ÎŸ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹.');
    if(gg.timeLocked) return T('ğŸ”’ ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚.');
    if(gg.userLocked) return T('ğŸ”’ ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ â€” Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Î³Î¿ÏÎ¬.');

    const rec=ensureHelpRec(gg.cid, gg.s.username);

    // Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· Î±Î³Î¿ÏÎ¬
    if(rec.paidAt){
      T('âœ… Î‰Î´Î· Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Î³Î¿ÏÎ¬ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ contest.');
      return setTimeout(()=>location.href='dashboard.html?paid=1', 700);
    }

    // Î³ÏÎ¬Ï†Î¿Ï…Î¼Îµ Ï„Î·Î½ Î±Î³Î¿ÏÎ¬
    rec.paidAt = now();
    rec.remaining = 3;
    rec.usedMatchIds = [];

    const all=R(K.H,{});
    all[gg.cid]=all[gg.cid]||{};
    all[gg.cid][gg.s.username]=rec;
    W(K.H,all);

    T('âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½ 3 HELP!');
    setTimeout(()=>location.href='dashboard.html?paid=1', 700);
  };
})();
</script>
</body>
</html>