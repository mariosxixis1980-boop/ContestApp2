<!DOCTYPE html>

<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Cyprus Match Predict</title>
<link href="icon-192.png" rel="icon"/>
<style>
    :root{
      --bg:#070b13;--b:rgba(255,255,255,.12);
      --t:#eaf1ff;--m:rgba(255,255,255,.65);
      --g:rgba(46,204,113,.20);--gb:rgba(46,204,113,.45);
      --a:rgba(241,196,15,.16);--ab:rgba(241,196,15,.45);
      --r:rgba(231,76,60,.14);--rb:rgba(231,76,60,.45);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;min-height:100vh;padding:18px;color:var(--t);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(40,110,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(0,255,170,.18), transparent 55%),
        var(--bg);
      display:flex;align-items:center;justify-content:center;
    }
    .card{
      width:min(520px, 100%);
      border:1px solid var(--b);
      border-radius:22px;
      padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    h1{margin:0;font-size:36px}
    .sub{margin-top:6px;color:var(--m);font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid var(--b);background:rgba(255,255,255,.06);color:var(--t);
      padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;
    }
    .g{background:var(--g);border-color:var(--gb)}
    .a{background:var(--a);border-color:var(--ab)}
    .box{
      border:1px solid var(--b);border-radius:18px;background:rgba(0,0,0,.18);
      padding:12px;margin-top:12px;
    }
    label{display:block;margin-top:10px;color:var(--m);font-weight:800}
    input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--b);
      background:rgba(0,0,0,.25);
      color:var(--t);
      outline:none;
      font-weight:800;
    }
    .mini{color:var(--m);font-weight:750;margin-top:8px}
    .tabs{display:flex;gap:10px;margin-top:12px}
    .tab{flex:1}
    .hide{display:none}
  </style>
</head>
<body>
<div class="card">
<div style="text-align:center;margin-bottom:12px;">
<div style="font-size:18px;font-weight:700;">Cyprus Match Predict</div>
<div style="font-size:13px;color:#C9A24D;letter-spacing:2px;margin-top:4px;">ğŸ‡¨ğŸ‡¾  C.M.P ğŸ‡¨ğŸ‡¾</div>
</div>
<h1>ğŸ” Login</h1>
<div class="sub">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Email &amp; Password (Supabase).</div>
<div class="box" id="nextBox">
<div class="mini" style="font-size:16px;font-weight:900">
        ğŸ“… <span id="nextText">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: -</span>
</div>
<div class="mini" id="nextSub" style="margin-top:6px;opacity:.95">-</div>
</div>
<div class="tabs">
<button class="btn a tab" id="tabLogin" type="button">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
<button class="btn tab" id="tabRegister" type="button">Î•Î³Î³ÏÎ±Ï†Î®</button>
</div>
<!-- Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ Supabase session, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ (Î´ÎµÎ½ ÏƒÎµ Ï€ÎµÏ„Î¬Î¼Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏƒÏ„Î¿ admin) -->
<div class="box hide" id="alreadyLoggedInBox">
<div class="mini" id="alreadyLoggedInMsg"></div>
<div class="row" style="margin-top:10px">
<button class="btn a" id="goAdminBtn" type="button">â¡ï¸ Admin</button>
<button class="btn a" id="goClientBtn" type="button">â¡ï¸ Î ÎµÎ»Î¬Ï„Î·Ï‚</button>
<button class="btn" id="doLogoutBtn" type="button">ğŸšª Logout</button>
</div>
</div>
<!-- LOGIN -->
<div class="box" id="loginBox">
<label>Email</label>
<input autocomplete="email" id="loginEmail" placeholder="email@example.com" type="email"/>
<label>Password</label>
<input autocomplete="current-password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
<div class="row">
<button class="btn g" id="loginBtn" type="button">âœ… Login</button>
<button class="btn" id="clearBtn" type="button">ğŸ§½ Clear</button>
<button class="btn" id="resetBtn" type="button">ğŸ” Reset Password</button>
</div>
<div class="mini" id="loginErr" style="color:#ffb3b3;display:none"></div>
<div class="mini">Tip: Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome.</div>
</div>
<!-- REGISTER -->
<div class="box hide" id="registerBox">
<label>Username (Î¥Î ÎŸÎ§Î¡Î•Î©Î¤Î™ÎšÎŸ)</label>
<input autocomplete="username" id="regUser" placeholder="Ï€.Ï‡ marios10"/>
<label>Email</label>
<input autocomplete="email" id="regEmail" placeholder="Ï€.Ï‡ name@gmail.com" type="email"/>
<label>Password</label>
<input autocomplete="new-password" id="regPass" placeholder="Î´Î¹Î¬Î»ÎµÎ¾Îµ password" type="password"/>
<div class="row">
<button class="btn g" id="regBtn" type="button">ğŸ†• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
<button class="btn" id="regClearBtn" type="button">ğŸ§½ Clear</button>
</div>
<div class="mini" id="regErr" style="color:#ffb3b3;display:none"></div>
<div class="mini" id="regOk" style="color:#b7ffcf;display:none"></div>
<div class="mini">Î˜Î± ÏƒÎ¿Ï… Î­ÏÎ¸ÎµÎ¹ email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹ÎºÏ„ÏŒ ÏƒÏ„Î¿ Supabase Auth settings.</div>
</div>
<p style="font-size:11px;text-align:center;color:rgba(255,255,255,.55);margin-top:12px;">
      Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÏƒÏ„Î¿Î¹Ï‡Î®Î¼Î±Ï„Î¿Ï‚.
    </p>
<p style="font-size:12px;text-align:center;margin-top:6px;color:rgba(255,255,255,.75);font-weight:700;">
      ÎœÎµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿Î´Î­Ï‡ÎµÏƒÏ„Îµ Ï„Î¿Ï…Ï‚
      <a href="terms.html" style="color:#eaf1ff;text-decoration:underline;" target="_blank">ÎŒÏÎ¿Ï…Ï‚ &amp; Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚</a>
      ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚
      <a href="rules.html" style="color:#eaf1ff;text-decoration:underline;" target="_blank">ÎšÎ±Î½ÏŒÎ½ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</a>.
    </p>
</div>
<script type="module">
    import { supabase } from "./supabase.js";

    const ADMIN_EMAIL = "mariosxixis1980@gmail.com";
    const KEY_NEXT = "nextContestStartISO";
    const byId = (id) => document.getElementById(id);


// --- Supabase config sanity check ---
async function assertSupabaseWorks() {
  try {
    // This triggers a lightweight request; if the key is wrong you often get 401/invalid api key.
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      console.error("Supabase getSession error:", error);
      return { ok: false, error };
    }
    return { ok: true, data };
  } catch (e) {
    console.error("Supabase config exception:", e);
    return { ok: false, error: e };
  }
}

    function setInlineMsg(id, msg){
      const el = byId(id);
      const text = String(msg || "").trim();
      if(!el) return;
      if(text){
        el.textContent = text;
        el.style.display = "block";
      }else{
        el.textContent = "";
        el.style.display = "none";
      }
    }
    function clearMsgs(){
      setInlineMsg("loginErr","");
      setInlineMsg("regErr","");
    }

    function fmtDateGreek(isoDate){
      const s = String(isoDate||"").trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
      const [yy,mm,dd] = s.split("-");
      return `${dd}/${mm}/${yy}`;
    }

    function renderNextContest(){
      const raw = String(localStorage.getItem(KEY_NEXT) || "");
      const iso = raw.replace(/"/g,"").trim();
      const pretty = fmtDateGreek(iso);

      if(pretty){
        byId("nextText").textContent = `ÎŸ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î±ÏÏ‡Î¯Î¶ÎµÎ¹ ÏƒÏ„Î¹Ï‚ ${pretty}`;
        byId("nextSub").textContent = "ÎœÎ­Ï‡ÏÎ¹ Ï„ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ login ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬.";
      }else{
        byId("nextText").textContent = "ÎŸ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î¸Î± Î±Î½Î±ÎºÎ¿Î¹Î½Ï‰Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±";
        byId("nextSub").textContent = "ÎŸ admin Î¸Î± Î²Î¬Î»ÎµÎ¹ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿ Admin Panel.";
      }
    }

    
    async function showAlreadyLoggedIn(session){
	    // Î”ÎµÎ¯Î¾Îµ Î¼Î®Î½Ï…Î¼Î± + ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î±Î½Ï„Î¯ Î³Î¹Î± auto redirect
	    const box = byId("alreadyLoggedInBox");
	    const msg = byId("alreadyLoggedInMsg");
	    if(msg) msg.textContent = "âœ… Î•Î¯ÏƒÎ±Î¹ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚. Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€Î¿Ï Î½Î± Ï€Î±Ï‚ Î® ÎºÎ¬Î½Îµ logout.";
	    if(box) box.classList.remove("hide");

	    const goAdminBtn = byId("goAdminBtn");
	    const goClientBtn = byId("goClientBtn");
	    const doLogoutBtn = byId("doLogoutBtn");

	    if(goAdminBtn) goAdminBtn.onclick = async () => { await goAfterLogin(session); };
	    if(goClientBtn) goClientBtn.onclick = () => { location.href = "dashboard.html"; };
	    if(doLogoutBtn) doLogoutBtn.onclick = async () => {
	      try { await supabase.auth.signOut(); } catch(e){ console.warn(e); }
	      location.reload();
	    };
    }

function showLogin(){
      clearMsgs();
      byId("loginBox").classList.remove("hide");
      byId("registerBox").classList.add("hide");
      byId("tabLogin").className = "btn a tab";
      byId("tabRegister").className = "btn tab";
    }

    function showRegister(){
      clearMsgs();
      byId("registerBox").classList.remove("hide");
      byId("loginBox").classList.add("hide");
      byId("tabRegister").className = "btn a tab";
      byId("tabLogin").className = "btn tab";
    }

    async function goAfterLogin(session){
      const email = String(session?.user?.email || "").toLowerCase();
      const username = email ? email.split("@")[0] : "user";
      const isAdmin = email && email === ADMIN_EMAIL.toLowerCase();

      // âœ… legacy session Î³Î¹Î± Ï„Î± Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î± pages (admin.js/dashboard ÎºÎ»Ï€)
      localStorage.setItem("session", JSON.stringify({
        username,
        email,
        isAdmin
      }));

      if(isAdmin){
        location.href = "admin.html";
    }
else{
        location.href = "dashboard.html";
      }
    }

    async function doLogin(){
      clearMsgs();
      const email = String(byId("loginEmail").value || "").trim().toLowerCase();
      const password = String(byId("loginPass").value || "");
      if(!email || !password) return setInlineMsg("loginErr","Î“ÏÎ¬ÏˆÎµ email ÎºÎ±Î¹ password.");

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){
  const msg = String(error.message || "");
  const status = error.status || error.code;
  if(status === 401 || /invalid api key/i.test(msg)){
    return setInlineMsg("loginErr","Login error: Invalid API key. Î’Î¬Î»Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ Publishable/Anon public key ÏƒÏ„Î¿ supabase.js (ÏŒÏ‡Î¹ secret).");
  }
  return setInlineMsg("loginErr", `Login error: ${msg}`);
}
      if(!data?.session) return setInlineMsg("loginErr","Î”ÎµÎ½ Î­Î³Î¹Î½Îµ session. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.");

      await goAfterLogin(data.session);
    }

    async function doRegister(){
      clearMsgs();
      const usernameRaw = String(byId("regUser").value || "").trim();
      const email = String(byId("regEmail").value || "").trim().toLowerCase();
      const password = String(byId("regPass").value || "");

      if(!email || !password){
        return setInlineMsg("regErr","Î“ÏÎ¬ÏˆÎµ email ÎºÎ±Î¹ password.");
      }

      // username Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒ ÏƒÏ„Î· Î²Î¬ÏƒÎ· (profiles.username ÎµÎ¯Î½Î±Î¹ NOT NULL)
      let username = usernameRaw || (email.split("@")[0] || "").trim();
      if(!username){
        username = "user_" + Math.random().toString(36).slice(2,8);
      }

      // Î‘Î½ ÎºÎ¬Ï€Î¿Î¹Î¿Ï‚ Î²Î¬Î»ÎµÎ¹ Ï„Î¿ admin email Î±Ï€ÏŒ Ï„Î¿ register, Ï„Î¿ ÎºÎ¬Î½Î¿Ï…Î¼Îµ admin profile
      const isAdmin = (email === ADMIN_EMAIL);

      // 1) Create auth user
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error){
        // Supabase errors (Ï€.Ï‡. "User already registered", rate limit, ÎºÏ„Î»)
        const msg = String(error.message || String(error) || "");
        const status = error.status || error.code;
        if(status === 401 || /invalid api key/i.test(msg)){
          return setInlineMsg("regErr","Register error: Invalid API key. Î’Î¬Î»Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ Publishable/Anon public key ÏƒÏ„Î¿ supabase.js (ÏŒÏ‡Î¹ secret).");
        }
        return setInlineMsg("regErr", "Register error: " + msg);
      }
      const user = data?.user;
      if(!user?.id){
        return setInlineMsg("regErr", "Register error: Î”ÎµÎ½ Ï€Î®ÏÎ± user id Î±Ï€ÏŒ Supabase.");
      }

      // 2) Create/Update profile row
      // Î£Ï„Î· Î²Î¬ÏƒÎ· Î· ÏƒÏ„Î®Î»Î· ÎµÎ¯Î½Î±Î¹ is_admin (ÏŒÏ‡Î¹ isAdmin)
      const baseProfile = { id: user.id, username, email, is_admin: isAdmin };

      // Î‘Î½ Ï„Î¿ username ÎµÎ¯Î½Î±Î¹ Î®Î´Î· Ï€Î¹Î±ÏƒÎ¼Î­Î½Î¿ (unique), Î´Î¿ÎºÎ¹Î¼Î¬Î¶Î¿Ï…Î¼Îµ 1 Ï†Î¿ÏÎ¬ Î¼Îµ suffix
      let profilePayload = baseProfile;
      let { error: pErr } = await supabase.from("profiles").upsert(profilePayload, { onConflict: "id" });

      if(pErr && String(pErr.code) === "23505"){
        // duplicate key -> Î¬Î»Î»Î±Î¾Îµ username ÎºÎ±Î¹ Î¾Î±Î½Î±Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ
        profilePayload = { ...baseProfile, username: `${username}_${Math.random().toString(36).slice(2,5)}` };
        const retry = await supabase.from("profiles").upsert(profilePayload, { onConflict: "id" });
        pErr = retry.error;
      }

      if(pErr){
        console.warn("profiles upsert error:", pErr);
        // Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ register ÏƒÏ„Î¿ Auth, Î±Ï€Î»Î¬ Î´ÎµÎ½ Î³ÏÎ¬Ï†Ï„Î·ÎºÎµ profile
        return setInlineMsg("regOk",
          "Î— ÎµÎ³Î³ÏÎ±Ï†Î® Î­Î³Î¹Î½Îµ, Î±Î»Î»Î¬ Î´ÎµÎ½ Î³ÏÎ¬Ï†Ï„Î·ÎºÎµ profile. (ÎˆÎ»ÎµÎ³Î¾Îµ RLS / table rules). " + (pErr.message || "")
        );
      }

      setInlineMsg("regOk","âœ… Î— ÎµÎ³Î³ÏÎ±Ï†Î® Î­Î³Î¹Î½Îµ! Î¤ÏÏÎ± ÎºÎ¬Î½Îµ login. (ÎŠÏƒÏ‰Ï‚ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ email confirm.)");
      showLogin();
    }
// INIT
    (async () => {
      showLogin();
      renderNextContest();

// Quick check: if the publishable (anon) key is wrong you'll get 401/Invalid API key.
const cfg = await assertSupabaseWorks();
if (!cfg.ok) {
  const msg = cfg.error?.message || String(cfg.error || "");
  setInlineMsg("loginErr","âš ï¸ Î ÏÏŒÎ²Î»Î·Î¼Î± Supabase: ÎˆÎ»ÎµÎ³Î¾Îµ Ï„Î¿ SUPABASE_ANON_KEY (Publishable/Anon public) ÏƒÏ„Î¿ supabase.js.\n" + msg);
}

      // --- Bind UI events (tabs & buttons) ---
      byId("tabLogin").addEventListener("click", showLogin);
      byId("tabRegister").addEventListener("click", showRegister);

      byId("loginBtn").addEventListener("click", doLogin);
      byId("clearBtn").addEventListener("click", () => {
        clearMsgs();
        byId("loginEmail").value = "";
        byId("loginPass").value = "";
      });

      byId("resetBtn").addEventListener("click", async () => {
        clearMsgs();
        const email = String(byId("loginEmail").value || "").trim().toLowerCase();
        if (!email) return setInlineMsg("loginErr", "Î“ÏÎ¬ÏˆÎµ Ï€ÏÏÏ„Î± Ï„Î¿ email ÏƒÎ¿Ï….");
        // âœ… Redirect back to reset.html after user clicks the email link
        const redirectTo = location.origin + location.pathname.replace(/[^\/]*$/, '') + "reset.html";
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) return setInlineMsg("loginErr", "Reset error: " + (error.message || String(error)));
        setInlineMsg("loginOk", "âœ… Î£Ï„Î¬Î»Î¸Î·ÎºÎµ email Î³Î¹Î± reset password (Î±Î½ Ï„Î¿ email Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).\n");
      });

      byId("regBtn").addEventListener("click", doRegister);
      byId("regClearBtn").addEventListener("click", () => {
        clearMsgs();
        byId("regUser").value = "";
        byId("regEmail").value = "";
        byId("regPass").value = "";
      });

      // Enter = submit
      ["loginEmail","loginPass"].forEach(id => {
        byId(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") doLogin();
        });
      });
      ["regUser","regEmail","regPass"].forEach(id => {
        byId(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") doRegister();
        });
      });

      const { data: sessData, error } = await supabase.auth.getSession();
      if (error) console.warn("getSession error:", error);

      // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· session, Î”Î•Î ÎºÎ¬Î½Î¿Ï…Î¼Îµ auto-redirect (Î³Î¹Î± Î½Î± Î¼Î·Î½ ÏƒÎµ Ï€ÎµÏ„Î¬ÎµÎ¹ ÎºÎ±Ï„ÎµÏ…Î¸ÎµÎ¯Î±Î½ ÏƒÏ„Î¿ Admin).
      // Î£Î¿Ï… Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚.
      if (sessData?.session) {
        await showAlreadyLoggedIn(sessData.session);
      }

      supabase.auth.onAuthStateChange(async (_event, session) => {
        // ÎŒÏ„Î±Î½ Î±Î»Î»Î¬Î¾ÎµÎ¹ auth state, Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ session Î´ÎµÎ¯Î¾Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚.
        if (session) await showAlreadyLoggedIn(session);
      });

      console.log("SUPABASE OK");
    })();;
  </script>
</body>
</html>
