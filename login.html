<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CMP Login</title>
  <style>
    body{font-family:Arial,system-ui;background:#0f172a;color:#fff;margin:0;padding:24px}
    .box{max-width:640px;margin:0 auto;background:#020617;padding:18px;border-radius:14px;border:1px solid #1f2937}
    .hide{display:none}
    .choice{background:#111827;border:1px solid #1f2937;padding:12px;border-radius:12px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{padding:10px 14px;border-radius:12px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .btn-secondary{background:#334155}
    .msg{margin-top:10px;opacity:.9}
  </style>
</head>
<body>
  <div class="box">
    <h2>Cyprus Match Predict</h2>

    <!-- keep your existing UI ids if you already have them -->
    <div id="loginBox">
      <!-- your existing inputs/buttons stay in your project; this file only needs the already-logged-in UI and logic -->
      <div class="msg">Χρησιμοποίησε τη φόρμα που έχεις ήδη για Login/Εγγραφή.</div>
    </div>

    <div id="alreadyLoggedInBox" class="choice hide">
      <div id="alreadyLoggedInMsg" class="msg"></div>
      <div class="row">
        <button id="alreadyAdminBtn">➡️ Admin</button>
        <button id="alreadyCustomerBtn">➡️ Πελάτης</button>
        <button id="alreadyLogoutBtn" class="btn-secondary">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./supabase.js";
    import { routeByRole, logout } from "./auth.js";

    function showAlready(input){
      const email = (typeof input === "string") ? input : (input?.email || "");
      const box = document.getElementById("alreadyLoggedInBox");
      const msg = document.getElementById("alreadyLoggedInMsg");
      if (msg) msg.textContent = `✅ Είσαι ήδη συνδεδεμένος ως ${email}. Διάλεξε που θες να μπεις:`;
      if (box) box.classList.remove("hide");
    }

    // buttons
    document.getElementById("alreadyAdminBtn")?.addEventListener("click", async () => {
      await routeByRole(); // θα στείλει admin σε admin.html
    });
    document.getElementById("alreadyCustomerBtn")?.addEventListener("click", () => {
      location.replace("dashboard.html"); // πελάτης πάντα dashboard
    });
    document.getElementById("alreadyLogoutBtn")?.addEventListener("click", logout);

    // ---------- Auto session (NO auto-redirect) ----------
    (async () => {
      const qs = new URLSearchParams(location.search);
      if (qs.get("logged_out") === "1") return;

      const { data } = await supabase.auth.getSession();
      const user = data?.session?.user;
      if (!user) return;

      showAlready(user);
    })();
  </script>
</body>
</html>