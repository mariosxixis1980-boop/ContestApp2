<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cyprus Match Predict</title>
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#070b13;--b:rgba(255,255,255,.12);
      --t:#eaf1ff;--m:rgba(255,255,255,.65);
      --g:rgba(46,204,113,.20);--gb:rgba(46,204,113,.45);
      --a:rgba(241,196,15,.16);--ab:rgba(241,196,15,.45);
      --r:rgba(231,76,60,.14);--rb:rgba(231,76,60,.45);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;min-height:100vh;padding:18px;color:var(--t);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(40,110,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(0,255,170,.18), transparent 55%),
        var(--bg);
      display:flex;align-items:center;justify-content:center;
    }
    .card{
      width:min(520px, 100%);
      border:1px solid var(--b);
      border-radius:22px;
      padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    h1{margin:0;font-size:36px}
    .sub{margin-top:6px;color:var(--m);font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid var(--b);background:rgba(255,255,255,.06);color:var(--t);
      padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;
    }
    .g{background:var(--g);border-color:var(--gb)}
    .a{background:var(--a);border-color:var(--ab)}
    .box{
      border:1px solid var(--b);border-radius:18px;background:rgba(0,0,0,.18);
      padding:12px;margin-top:12px;
    }
    label{display:block;margin-top:10px;color:var(--m);font-weight:800}
    input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--b);
      background:rgba(0,0,0,.25);
      color:var(--t);
      outline:none;
      font-weight:800;
    }
    .mini{color:var(--m);font-weight:750;margin-top:8px}
    .tabs{display:flex;gap:10px;margin-top:12px}
    .tab{flex:1}
    .hide{display:none}
  </style>
</head>

<body>
  <div class="card">
    <div style="text-align:center;margin-bottom:12px;">
      <div style="font-size:18px;font-weight:700;">Cyprus Match Predict</div>
      <div style="font-size:13px;color:#C9A24D;letter-spacing:2px;margin-top:4px;">ğŸ‡¨ğŸ‡¾  C.M.P ğŸ‡¨ğŸ‡¾</div>
    </div>

    <h1>ğŸ” Login</h1>
    <div class="sub">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Email & Password (Supabase).</div>

    <div class="box" id="nextBox">
      <div class="mini" style="font-size:16px;font-weight:900">
        ğŸ“… <span id="nextText">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: -</span>
      </div>
      <div class="mini" id="nextSub" style="margin-top:6px;opacity:.95">-</div>
    </div>

    <div class="tabs">
      <button class="btn a tab" id="tabLogin" type="button">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
      <button class="btn tab" id="tabRegister" type="button">Î•Î³Î³ÏÎ±Ï†Î®</button>
    </div>

    <!-- Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ Supabase session, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ (Î´ÎµÎ½ ÏƒÎµ Ï€ÎµÏ„Î¬Î¼Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏƒÏ„Î¿ admin) -->
    <div id="alreadyLoggedInBox" class="box hide">
      <div id="alreadyLoggedInMsg" class="mini"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn a" id="goAdminBtn" type="button">â¡ï¸ Admin</button>
        <button class="btn a" id="goClientBtn" type="button">â¡ï¸ Î ÎµÎ»Î¬Ï„Î·Ï‚</button>
        <button class="btn" id="doLogoutBtn" type="button">ğŸšª Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="box" id="loginBox">
      <label>Email</label>
      <input id="loginEmail" type="email" autocomplete="email" placeholder="email@example.com"/>

      <label>Password</label>
      <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>

      <div class="row">
        <button class="btn g" id="loginBtn" type="button">âœ… Login</button>
        <button class="btn" id="clearBtn" type="button">ğŸ§½ Clear</button>
        <button class="btn" id="resetBtn" type="button">ğŸ” Reset Password</button>
      </div>

      <div id="loginErr" class="mini" style="color:#ffb3b3;display:none"></div>
      <div class="mini">Tip: Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome.</div>
    </div>

    <!-- REGISTER -->
    <div class="box hide" id="registerBox">
	      <label>Username (Î¥Î ÎŸÎ§Î¡Î•Î©Î¤Î™ÎšÎŸ)</label>
      <input id="regUser" autocomplete="username" placeholder="Ï€.Ï‡ marios10"/>

      <label>Email</label>
      <input id="regEmail" type="email" autocomplete="email" placeholder="Ï€.Ï‡ name@gmail.com"/>

      <label>Password</label>
      <input id="regPass" type="password" autocomplete="new-password" placeholder="Î´Î¹Î¬Î»ÎµÎ¾Îµ password"/>

      <div class="row">
        <button class="btn g" id="regBtn" type="button">ğŸ†• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
        <button class="btn" id="regClearBtn" type="button">ğŸ§½ Clear</button>
      </div>

      <div id="regErr" class="mini" style="color:#ffb3b3;display:none"></div>
	      <div id="regOk" class="mini" style="color:#b7ffcf;display:none"></div>
      <div class="mini">Î˜Î± ÏƒÎ¿Ï… Î­ÏÎ¸ÎµÎ¹ email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹ÎºÏ„ÏŒ ÏƒÏ„Î¿ Supabase Auth settings.</div>
    </div>

    <p style="font-size:11px;text-align:center;color:rgba(255,255,255,.55);margin-top:12px;">
      Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÏƒÏ„Î¿Î¹Ï‡Î®Î¼Î±Ï„Î¿Ï‚.
    </p>

    <p style="font-size:12px;text-align:center;margin-top:6px;color:rgba(255,255,255,.75);font-weight:700;">
      ÎœÎµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿Î´Î­Ï‡ÎµÏƒÏ„Îµ Ï„Î¿Ï…Ï‚
      <a href="terms.html" target="_blank" style="color:#eaf1ff;text-decoration:underline;">ÎŒÏÎ¿Ï…Ï‚ &amp; Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚</a>
      ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚
      <a href="rules.html" target="_blank" style="color:#eaf1ff;text-decoration:underline;">ÎšÎ±Î½ÏŒÎ½ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</a>.
    </p>
  </div>

  <script type="module">
import { getSupabase, clearSupabaseConfig } from './supabase.js';

const $ = (id) => document.getElementById(id);

function show(el, on=true){ if(!el) return; el.classList.toggle('hide', !on); }
function setText(el, txt){ if(!el) return; el.textContent = txt ?? ''; }

function setLoginErr(txt){ setText($('loginErr'), txt); show($('loginErr'), !!txt); }
function setRegErr(txt){ setText($('regErr'), txt); show($('regErr'), !!txt); }
function setRegOk(txt){ setText($('regOk'), txt); show($('regOk'), !!txt); }

function setActiveTab(which){
  const tabLogin = $('tabLogin');
  const tabRegister = $('tabRegister');
  const loginBox = $('loginBox');
  const registerBox = $('registerBox');

  if (which === 'register'){
    tabRegister?.classList.add('active');
    tabLogin?.classList.remove('active');
    show(registerBox, true);
    show(loginBox, false);
    setLoginErr('');
  } else {
    tabLogin?.classList.add('active');
    tabRegister?.classList.remove('active');
    show(loginBox, true);
    show(registerBox, false);
    setRegErr(''); setRegOk('');
  }
}

async function fetchProfileByEmail(supabase, email){
  if(!email) return null;
  const { data, error } = await supabase
    .from('users')
    .select('username, is_admin')
    .eq('email', email)
    .maybeSingle();

  if(error) {
    console.warn('profile fetch error:', error);
    return null;
  }
  return data || null;
}

function saveSession(user, profile){
  try{
    localStorage.setItem('CMP_USER', JSON.stringify(user));
    localStorage.setItem('CMP_PROFILE', JSON.stringify(profile));
  }catch(e){
    console.warn('localStorage save error:', e);
  }
}

function clearSession(){
  try{
    localStorage.removeItem('CMP_USER');
    localStorage.removeItem('CMP_PROFILE');
  }catch(e){}
}

function gotoByRole(profile){
  if(profile?.is_admin === true) {
    window.location.href = 'admin.html';
    return;
  }
  window.location.href = 'dashboard.html';
}

async function showAlreadyLoggedIn(supabase, session){
  const box = $('alreadyLoggedInBox');
  const msg = $('alreadyLoggedInMsg');
  const btnAdmin = $('goAdminBtn');
  const btnDash = $('goClientBtn');
  const btnLogout = $('doLogoutBtn');

  const email = session?.user?.email || '';
  const prof = (await fetchProfileByEmail(supabase, email)) || { username: email.split('@')[0] || 'user', is_admin: false };

  setText(msg, `Î•Î¯ÏƒÎ±Î¹ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚: ${prof.username} (${email})`);
  show(box, true);

  // Î‘Î½ ÎµÎ¯Î½Î±Î¹ admin, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ "Î Î®Î³Î±Î¹Î½Îµ Admin", Î±Î»Î»Î¹ÏÏ‚ "Î Î®Î³Î±Î¹Î½Îµ Dashboard"
  show(btnAdmin, prof.is_admin === true);
  show(btnDash, prof.is_admin !== true);

  btnAdmin?.addEventListener('click', () => gotoByRole({ ...prof, is_admin: true }));
  btnDash?.addEventListener('click', () => gotoByRole({ ...prof, is_admin: false }));

  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    clearSession();
    show(box, false);
    setActiveTab('login');
  });
}

(async function init(){
  // Tabs
  $('tabLogin')?.addEventListener('click', () => setActiveTab('login'));
  $('tabRegister')?.addEventListener('click', () => setActiveTab('register'));
    alert('ÎˆÎ³Î¹Î½Îµ clear Ï„Î± Supabase settings. ÎšÎ¬Î½Îµ refresh Î³Î¹Î± Î½Î± ÏƒÏ„Î± Î¶Î·Ï„Î®ÏƒÎµÎ¹ Î¾Î±Î½Î¬.');
  });

  let supabase;
  try {
    supabase = await getSupabase();
    console.log('Supabase ready');
  } catch (e) {
    console.error(e);
    setLoginErr('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ‰ÏƒÏ„Î¬ Supabase settings.');
    return;
  }

  // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ session, Î´ÎµÎ¯Î¾Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ (Î´ÎµÎ½ ÎºÎ¬Î½Î¿Ï…Î¼Îµ auto-redirect)
  try{
    const { data, error } = await supabase.auth.getSession();
    if(error) console.warn('getSession error:', error);
    if(data?.session){
      await showAlreadyLoggedIn(supabase, data.session);
    }
  }catch(e){
    console.warn('getSession exception:', e);
  }

  // LOGIN
  $('loginBtn')?.addEventListener('click', async () => {
    setLoginErr('');
    const email = $('loginEmail')?.value?.trim() || '';
    const password = $('loginPass')?.value || '';

    if(!email || !password){
      setLoginErr('Î’Î¬Î»Îµ Email ÎºÎ±Î¹ Password.');
      return;
    }

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){
      setLoginErr('Login error: ' + error.message);
      return;
    }

    const user = data?.user;
    const prof = (await fetchProfileByEmail(supabase, email)) || { username: email.split('@')[0] || 'user', is_admin: false };
    saveSession(user, prof);
    gotoByRole(prof);
  });

  $('clearBtn')?.addEventListener('click', () => {
    if($('loginEmail')) $('loginEmail').value = '';
    if($('loginPass')) $('loginPass').value = '';
    setLoginErr('');
  });

  $('resetBtn')?.addEventListener('click', async () => {
    setLoginErr('');
    const email = $('loginEmail')?.value?.trim() || '';
    if(!email){
      setLoginErr('Î“ÏÎ¬ÏˆÎµ Ï€ÏÏÏ„Î± Email Î³Î¹Î± Reset Password.');
      return;
    }
    const { error } = await supabase.auth.resetPasswordForEmail(email);
    if(error){
      setLoginErr('Reset error: ' + error.message);
      return;
    }
    setLoginErr('Î£Î¿Ï… ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ email Î³Î¹Î± reset (Î±Î½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î± Auth settings).');
  });

  // REGISTER
  $('regBtn')?.addEventListener('click', async () => {
    setRegErr(''); setRegOk('');
    const username = $('regUser')?.value?.trim() || '';
    const email = $('regEmail')?.value?.trim() || '';
    const password = $('regPass')?.value || '';

    if(!email || !password){
      setRegErr('Î’Î¬Î»Îµ Email ÎºÎ±Î¹ Password.');
      return;
    }

    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error){
      setRegErr('Register error: ' + error.message);
      return;
    }

    // Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ ÎºÎ±Î¹ ÏƒÏ„Î¿ users table (Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ Î»ÏŒÎ³Ï‰ RLS)
    try{
      await supabase.from('users').upsert([{ email, username: username || email.split('@')[0], is_admin: false }], { onConflict: 'email' });
    }catch(e){}

    setRegOk('ÎˆÎ³Î¹Î½Îµ ÎµÎ³Î³ÏÎ±Ï†Î®. ÎšÎ¬Î½Îµ Login.');
    setActiveTab('login');
    if($('loginEmail')) $('loginEmail').value = email;
  });

  $('regClearBtn')?.addEventListener('click', () => {
    if($('regUser')) $('regUser').value = '';
    if($('regEmail')) $('regEmail').value = '';
    if($('regPass')) $('regPass').value = '';
    setRegErr(''); setRegOk('');
  });

  // default tab
  setActiveTab('login');
})();
</script>
</body>
</html>
