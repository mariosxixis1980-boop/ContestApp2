<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cyprus Match Predict - Login</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#061b1f;color:#e9f7ff}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:28px}
    .sub{opacity:.85;margin:0 0 14px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;font-size:12px;opacity:.9;margin:10px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.25);color:#e9f7ff;outline:none}
    input:focus{border-color:rgba(0,190,255,.45)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#e9f7ff;padding:10px 12px;border-radius:10px}
    button.primary{background:rgba(0,190,255,.20);border-color:rgba(0,190,255,.35)}
    button.danger{background:rgba(255,80,80,.16);border-color:rgba(255,80,80,.35)}
    .msg{margin-top:12px;min-height:20px;font-size:13px;opacity:.95}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);font-size:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .small{font-size:12px;opacity:.8}
    .hidden{display:none!important}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>ğŸ”’ Login</h1>
          <p class="sub">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Email &amp; Password (Supabase).</p>
        </div>
        <div class="pill" id="supStatus">â³ Supabaseâ€¦</div>
      </div>

      <div id="alreadyBox" class="hidden">
        <div class="pill">âœ… Î•Î¯ÏƒÎ±Î¹ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚</div>
        <div class="small" id="alreadyText" style="margin-top:6px;"></div>
        <div class="btns" style="margin-top:10px;">
          <button id="goDashboard" class="primary" type="button">ğŸ‘¤ Î ÎµÎ»Î¬Ï„Î·Ï‚ (Dashboard)</button>
          <button id="goAdmin" class="primary" type="button">ğŸ›  Admin</button>
          <button id="logoutBtn" class="danger" type="button">ğŸšª Logout</button>
        </div>
        <div class="hr"></div>
      </div>

      <div class="row">
        <div class="col">
          <h3 style="margin:0 0 6px;">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</h3>
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="email@example.com" />
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="btns">
            <button id="loginBtn" class="primary" type="button">Login</button>
            <button id="resetBtn" type="button">Reset Password</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>
          <div class="msg" id="msg"></div>
          <div class="small">Tip: Î‘Î½ Î²Î¬Î»ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome.</div>
        </div>

        <div class="col">
          <h3 style="margin:0 0 6px;">Register</h3>
          <label for="regUser">Username (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
          <input id="regUser" type="text" autocomplete="username" placeholder="Ï€.Ï‡ marios10" />
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" autocomplete="email" placeholder="Ï€.Ï‡ name@gmail.com" />
          <label for="regPass">Password</label>
          <input id="regPass" type="password" autocomplete="new-password" placeholder="Î´Î¹Î¬Î»ÎµÎ¾Îµ password" />
          <div class="btns">
            <button id="regBtn" class="primary" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
            <button id="regClearBtn" type="button">Clear</button>
          </div>
          <div class="msg" id="regMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase (CDN) + App logic: ONE SCRIPT ONLY -->
  <script>
    // 1) Î’Î‘Î›Î• Ï„Î± Î´Î¹ÎºÎ¬ ÏƒÎ¿Ï… (Project URL + anon key)
    const SUPABASE_URL = localStorage.getItem('CMP_SUPABASE_URL') || '';
    const SUPABASE_ANON = localStorage.getItem('CMP_SUPABASE_ANON') || '';

    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½, Î¶Î®Ï„Î± Ï„Î± ÎœÎ™Î‘ Ï†Î¿ÏÎ¬.
    function ensureKeys() {
      if (!SUPABASE_URL || !SUPABASE_ANON) {
        const u = prompt('Î’Î¬Î»Îµ Supabase Project URL:');
        const k = prompt('Î’Î¬Î»Îµ Supabase anon key:');
        if (!u || !k) return null;
        localStorage.setItem('CMP_SUPABASE_URL', u.trim());
        localStorage.setItem('CMP_SUPABASE_ANON', k.trim());
        return { url: u.trim(), key: k.trim() };
      }
      return { url: SUPABASE_URL.trim(), key: SUPABASE_ANON.trim() };
    }

    // Load Supabase client from CDN dynamically (Ï‡Ï‰ÏÎ¯Ï‚ imports Ï€Î¿Ï… ÏƒÏ€Î¬Î½Îµ).
    function loadSupabaseCDN() {
      return new Promise((resolve, reject) => {
        if (window.supabase) return resolve(window.supabase);
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
        s.onload = () => window.supabase ? resolve(window.supabase) : reject(new Error('Supabase CDN load failed'));
        s.onerror = () => reject(new Error('Supabase CDN load failed'));
        document.head.appendChild(s);
      });
    }

    // UI helpers
    const $ = (id) => document.getElementById(id);
    const setMsg = (t) => { $('msg').textContent = t || ''; };
    const setRegMsg = (t) => { $('regMsg').textContent = t || ''; };

    function setSupStatus(t) { $('supStatus').textContent = t; }

    // Route based on users table
    async function routeUserByEmail(client, email) {
      // IMPORTANT: requires table "users" with columns: username, email, is_admin (bool)
      const { data: profile, error } = await client
        .from('users')
        .select('username, email, is_admin')
        .eq('email', email)
        .maybeSingle();

      if (error) {
        console.warn('profile error:', error);
        setMsg('Î£Ï†Î¬Î»Î¼Î± profile: ' + (error.message || 'unknown'));
        return null;
      }
      if (!profile) {
        setMsg('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ profile ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± users Î³Î¹Î±: ' + email);
        return null;
      }

      // Save
      localStorage.setItem('CMP_PROFILE', JSON.stringify(profile));
      localStorage.setItem('CMP_USER_EMAIL', email);

      // Redirect
      if (profile.is_admin === true) {
        window.location.href = 'admin.html';
      } else {
        window.location.href = 'dashboard.html';
      }
      return profile;
    }

    // Main
    (async () => {
      try {
        const keys = ensureKeys();
        if (!keys) { setSupStatus('âŒ Î§Ï‰ÏÎ¯Ï‚ keys'); return; }

        await loadSupabaseCDN();
        const client = window.supabase.createClient(keys.url, keys.key);
        window.__CMP_SUPABASE__ = client;
        setSupStatus('âœ… Supabase ready');
        console.log('Supabase ready');

        // If session exists => AUTO redirect (ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Î¸Î­Î»ÎµÎ¹Ï‚)
        const { data: sessData, error: sessErr } = await client.auth.getSession();
        if (sessErr) console.warn('getSession error:', sessErr);

        if (sessData && sessData.session) {
          const email = sessData.session.user.email || '';
          $('alreadyBox').classList.remove('hidden');
          $('alreadyText').textContent = `Î£Ï…Î½Î´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚: ${email}`;
          setMsg('Î£Îµ Ï€Î¬Ï‰ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÎµÎºÎµÎ¯ Ï€Î¿Ï… Ï€ÏÎ­Ï€ÎµÎ¹â€¦');
          // auto-route
          await routeUserByEmail(client, email);
          // (Î±Î½ Î´ÎµÎ½ Î²ÏÎ®ÎºÎµ profile, Î¼Î­Î½ÎµÎ¹ ÎµÎ´Ï Î³Î¹Î± Î½Î± Ï„Î¿ Î´ÎµÎ¹Ï‚)
        }

        // Buttons (always wired)
        $('clearBtn').onclick = () => { $('email').value=''; $('password').value=''; setMsg(''); };
        $('regClearBtn').onclick = () => { $('regUser').value=''; $('regEmail').value=''; $('regPass').value=''; setRegMsg(''); };

        $('loginBtn').onclick = async () => {
          setMsg('Î£ÏÎ½Î´ÎµÏƒÎ·â€¦');
          const email = $('email').value.trim();
          const password = $('password').value;

          if (!email || !password) { setMsg('Î’Î¬Î»Îµ email + password'); return; }

          const { data, error } = await client.auth.signInWithPassword({ email, password });
          if (error) { setMsg('Login error: ' + error.message); return; }

          const userEmail = data.user?.email || email;
          setMsg('OK. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏŒÎ»Î¿Ï…â€¦');
          await routeUserByEmail(client, userEmail);
        };

        $('resetBtn').onclick = async () => {
          const email = $('email').value.trim();
          if (!email) { setMsg('Î’Î¬Î»Îµ email Ï€ÏÏÏ„Î± Î³Î¹Î± reset.'); return; }
          setMsg('Î£Ï„Î­Î»Î½Ï‰ reset emailâ€¦');
          const { error } = await client.auth.resetPasswordForEmail(email);
          if (error) { setMsg('Reset error: ' + error.message); return; }
          setMsg('ÎˆÎ³Î¹Î½Îµ! Î”ÎµÏ‚ Ï„Î¿ email ÏƒÎ¿Ï… Î³Î¹Î± reset link.');
        };

        $('regBtn').onclick = async () => {
          setRegMsg('Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±â€¦');
          const username = $('regUser').value.trim();
          const email = $('regEmail').value.trim();
          const password = $('regPass').value;

          if (!email || !password) { setRegMsg('Î’Î¬Î»Îµ email + password'); return; }

          const { data, error } = await client.auth.signUp({ email, password });
          if (error) { setRegMsg('Register error: ' + error.message); return; }

          // Create profile row in users table (best-effort)
          const is_admin = false;
          const { error: insErr } = await client.from('users').upsert({
            email,
            username: username || email.split('@')[0],
            is_admin
          }, { onConflict: 'email' });

          if (insErr) console.warn('users upsert error:', insErr);

          setRegMsg('ÎŸÎš! ÎˆÎ³Î¹Î½Îµ ÎµÎ³Î³ÏÎ±Ï†Î®. Î‘Î½ Î­Ï‡ÎµÎ¹Ï‚ email confirmation, Î­Î»ÎµÎ³Î¾Îµ Ï„Î¿ email.');
        };

        $('logoutBtn').onclick = async () => {
          setMsg('Logoutâ€¦');
          await client.auth.signOut();
          localStorage.removeItem('CMP_PROFILE');
          localStorage.removeItem('CMP_USER_EMAIL');
          $('alreadyBox').classList.add('hidden');
          setMsg('ÎˆÎºÎ±Î½ÎµÏ‚ logout.');
        };

        $('goDashboard').onclick = () => window.location.href = 'dashboard.html';
        $('goAdmin').onclick = () => window.location.href = 'admin.html';

      } catch (e) {
        console.error(e);
        setSupStatus('âŒ Error');
        setMsg('Error: ' + (e.message || e));
      }
    })();
  </script>
</body>
</html>
