<!DOCTYPE html>

<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Cyprus Match Predict</title>
<link href="icon-192.png" rel="icon"/>
<style>
    :root{
      --bg:#070b13;--b:rgba(255,255,255,.12);
      --t:#eaf1ff;--m:rgba(255,255,255,.65);
      --g:rgba(46,204,113,.20);--gb:rgba(46,204,113,.45);
      --a:rgba(241,196,15,.16);--ab:rgba(241,196,15,.45);
      --r:rgba(231,76,60,.14);--rb:rgba(231,76,60,.45);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;min-height:100vh;padding:18px;color:var(--t);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(40,110,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(0,255,170,.18), transparent 55%),
        var(--bg);
      display:flex;align-items:center;justify-content:center;
    }
    .card{
      width:min(520px, 100%);
      border:1px solid var(--b);
      border-radius:22px;
      padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    h1{margin:0;font-size:36px}
    .sub{margin-top:6px;color:var(--m);font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid var(--b);background:rgba(255,255,255,.06);color:var(--t);
      padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;
    }
    .g{background:var(--g);border-color:var(--gb)}
    .a{background:var(--a);border-color:var(--ab)}
    .box{
      border:1px solid var(--b);border-radius:18px;background:rgba(0,0,0,.18);
      padding:12px;margin-top:12px;
    }
    label{display:block;margin-top:10px;color:var(--m);font-weight:800}
    input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--b);
      background:rgba(0,0,0,.25);
      color:var(--t);
      outline:none;
      font-weight:800;
    }
    .mini{color:var(--m);font-weight:750;margin-top:8px}
    .tabs{display:flex;gap:10px;margin-top:12px}
    .tab{flex:1}
    .hide{display:none}
  </style>
</head>
<body>
<div class="card">
<div style="text-align:center;margin-bottom:12px;">
<div style="font-size:18px;font-weight:700;">Cyprus Match Predict</div>
<div style="font-size:13px;color:#C9A24D;letter-spacing:2px;margin-top:4px;">ğŸ‡¨ğŸ‡¾  C.M.P ğŸ‡¨ğŸ‡¾</div>
</div>
<h1>ğŸ” Login</h1>
<div class="sub">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Email &amp; Password (Supabase).</div>
<div class="box" id="nextBox">
<div class="mini" style="font-size:16px;font-weight:900">
        ğŸ“… <span id="nextText">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚: -</span>
</div>
<div class="mini" id="nextSub" style="margin-top:6px;opacity:.95">-</div>
</div>
<div class="tabs">
<button class="btn a tab" id="tabLogin" type="button">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
<button class="btn tab" id="tabRegister" type="button">Î•Î³Î³ÏÎ±Ï†Î®</button>
</div>
<!-- Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ Supabase session, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ (Î´ÎµÎ½ ÏƒÎµ Ï€ÎµÏ„Î¬Î¼Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏƒÏ„Î¿ admin) -->
<div class="box hide" id="alreadyLoggedInBox">
<div class="mini" id="alreadyLoggedInMsg"></div>
<div class="row" style="margin-top:10px">
<button class="btn a" id="goAdminBtn" type="button">â¡ï¸ Admin</button>
<button class="btn a" id="goClientBtn" type="button">â¡ï¸ Î ÎµÎ»Î¬Ï„Î·Ï‚</button>
<button class="btn" id="doLogoutBtn" type="button">ğŸšª Logout</button>
</div>
</div>
<!-- LOGIN -->
<div class="box" id="loginBox">
<label>Email</label>
<input autocomplete="email" id="loginEmail" placeholder="email@example.com" type="email"/>
<label>Password</label>
<input autocomplete="current-password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
<div class="row">
<button class="btn g" id="loginBtn" type="button">âœ… Login</button>
<button class="btn" id="clearBtn" type="button">ğŸ§½ Clear</button>
<button class="btn" id="resetBtn" type="button">ğŸ” Reset Password</button>
</div>
<div class="mini" id="loginErr" style="color:#ffb3b3;display:none"></div>
<div class="mini">Tip: Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome.</div>
</div>
<!-- REGISTER -->
<div class="box hide" id="registerBox">
<label>Username (Î¥Î ÎŸÎ§Î¡Î•Î©Î¤Î™ÎšÎŸ)</label>
<input autocomplete="username" id="regUser" placeholder="Ï€.Ï‡ marios10"/>
<label>Email</label>
<input autocomplete="email" id="regEmail" placeholder="Ï€.Ï‡ name@gmail.com" type="email"/>
<label>Password</label>
<input autocomplete="new-password" id="regPass" placeholder="Î´Î¹Î¬Î»ÎµÎ¾Îµ password" type="password"/>
<div class="row">
<button class="btn g" id="regBtn" type="button">ğŸ†• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
<button class="btn" id="regClearBtn" type="button">ğŸ§½ Clear</button>
</div>
<div class="mini" id="regErr" style="color:#ffb3b3;display:none"></div>
<div class="mini" id="regOk" style="color:#b7ffcf;display:none"></div>
<div class="mini">Î˜Î± ÏƒÎ¿Ï… Î­ÏÎ¸ÎµÎ¹ email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹ÎºÏ„ÏŒ ÏƒÏ„Î¿ Supabase Auth settings.</div>
</div>
<p style="font-size:11px;text-align:center;color:rgba(255,255,255,.55);margin-top:12px;">
      Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÏƒÏ„Î¿Î¹Ï‡Î®Î¼Î±Ï„Î¿Ï‚.
    </p>
<p style="font-size:12px;text-align:center;margin-top:6px;color:rgba(255,255,255,.75);font-weight:700;">
      ÎœÎµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿Î´Î­Ï‡ÎµÏƒÏ„Îµ Ï„Î¿Ï…Ï‚
      <a href="terms.html" style="color:#eaf1ff;text-decoration:underline;" target="_blank">ÎŒÏÎ¿Ï…Ï‚ &amp; Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚</a>
      ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚
      <a href="rules.html" style="color:#eaf1ff;text-decoration:underline;" target="_blank">ÎšÎ±Î½ÏŒÎ½ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</a>.
    </p>
</div>
<script type="module">
import { supabase } from "./supabase.js";

const $ = (id) => document.getElementById(id);

const loginErr = $("loginErr");
const regErr = $("regErr");
const regOk = $("regOk");

const setBox = (el, text, ok=false) => {
  if (!el) return;
  el.textContent = text || "";
  el.style.display = text ? "block" : "none";
  if (el === regOk) return;
  el.style.color = ok ? "#b8ffcf" : "#ffb8b8";
};

const emailInput = $("loginEmail");
const passInput  = $("loginPass");

const regUserInput = $("regUser");
const regEmailInput = $("regEmail");
const regPassInput  = $("regPass");

const tabLogin = $("tabLogin");
const tabRegister = $("tabRegister");
const loginBox = $("loginBox");
const registerBox = $("registerBox");

const alreadyBox = $("alreadyLoggedInBox");
const doLogoutBtn = $("doLogoutBtn");
const goAdminBtn = $("goAdminBtn");
const goClientBtn = $("goClientBtn");

function showLogin(){
  loginBox?.classList.remove("hide");
  registerBox?.classList.add("hide");
  tabLogin?.classList.add("active");
  tabRegister?.classList.remove("active");
  alreadyBox?.classList.add("hide");
  setBox(loginErr, "");
  setBox(regErr, "");
  setBox(regOk, "");
}
function showRegister(){
  registerBox?.classList.remove("hide");
  loginBox?.classList.add("hide");
  tabRegister?.classList.add("active");
  tabLogin?.classList.remove("active");
  alreadyBox?.classList.add("hide");
  setBox(loginErr, "");
  setBox(regErr, "");
  setBox(regOk, "");
}

tabLogin?.addEventListener("click", showLogin);
tabRegister?.addEventListener("click", showRegister);

// ---------- Profile helpers ----------
async function getOrCreateProfile(user, preferredUsername){
  const { data: prof, error: e1 } = await supabase
    .from("profiles")
    .select("id, email, username, is_admin")
    .eq("id", user.id)
    .maybeSingle();

  if (prof) return prof;

  // fallback by email (for old rows)
  const { data: byEmail } = await supabase
    .from("profiles")
    .select("id, email, username, is_admin")
    .eq("email", user.email)
    .maybeSingle();
  if (byEmail) return byEmail;

  const username =
    (preferredUsername || user.user_metadata?.username || "").trim() ||
    (user.email ? user.email.split("@")[0] : "user");

  const { data: created, error: e3 } = await supabase
    .from("profiles")
    .insert([{ id: user.id, email: user.email, username }])
    .select("id, email, username, is_admin")
    .maybeSingle();

  if (e3) {
    console.warn("profile create error", e3);
    return { id: user.id, email: user.email, username, is_admin: false };
  }
  return created || { id: user.id, email: user.email, username, is_admin: false };
}

async function redirectByRole(user){
  const profile = await getOrCreateProfile(user);
  const isAdmin = !!profile?.is_admin;
  location.replace(isAdmin ? "admin.html" : "dashboard.html");
}

// ---------- Auto session (NO auto redirect) ----------
(async () => {
  const { data, error } = await supabase.auth.getSession();
  if (error) console.warn("getSession error", error);
  const session = data?.session;

  if (!session?.user) {
    showLogin();
    return;
  }

  // âœ… Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ session, Î”Î•Î ÎºÎ¬Î½Î¿Ï…Î¼Îµ auto-redirect (ÏƒÏ€Î¬ÎµÎ¹ Ï„Î¿ loop).
  // Î”ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚: Admin / Î ÎµÎ»Î¬Ï„Î·Ï‚ / Logout
  loginBox?.classList.add("hide");
  registerBox?.classList.add("hide");
  alreadyBox?.classList.remove("hide");

  const em = session.user.email || "";
  const msgEl = $("alreadyLoggedInMsg");
  if (msgEl) msgEl.textContent = `âœ… Î•Î¯ÏƒÎ±Î¹ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚${em ? " Ï‰Ï‚ " + em : ""}. Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€Î¿Ï… Î¸ÎµÏ‚ Î½Î± Î¼Ï€ÎµÎ¹Ï‚:`;
})();

// ---------- Login ----------
$("loginBtn")?.addEventListener("click", async () => {
  setBox(loginErr, "Î“Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏÎ½Î´ÎµÏƒÎ·...");
  const email = (emailInput?.value || "").trim();
  const password = passInput?.value || "";
  if (!email || !password) { setBox(loginErr, "Î’Î¬Î»Îµ Email ÎºÎ±Î¹ Password."); return; }

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { setBox(loginErr, error.message); return; }
  const user = data?.user;
  if (!user) { setBox(loginErr, "ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ Î»Î¬Î¸Î¿Ï‚. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬."); return; }

  setBox(loginErr, "Î£ÏÎ½Î´ÎµÏƒÎ· OK âœ…", true);
  await redirectByRole(user);
});

passInput?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("loginBtn")?.click(); });

// ---------- Reset password ----------
$("resetBtn")?.addEventListener("click", async () => {
  setBox(loginErr, "Î£Ï„Î­Î»Î½Ï‰ email ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚...");
  const email = (emailInput?.value || "").trim();
  if (!email) { setBox(loginErr, "Î“ÏÎ¬ÏˆÎµ Ï€ÏÏÏ„Î± Ï„Î¿ email."); return; }

  const redirectTo = location.origin + location.pathname.replace("login.html", "update-password.html");
  const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });

  if (error) { setBox(loginErr, error.message); return; }
  setBox(loginErr, "ÎˆÏ†Ï…Î³Îµ email ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚ âœ… (Î´ÎµÏ‚ Inbox/Spam).", true);
});

// ---------- Clear login ----------
$("clearBtn")?.addEventListener("click", () => {
  if (emailInput) emailInput.value = "";
  if (passInput) passInput.value = "";
  setBox(loginErr, "");
});

// ---------- Register ----------
$("regBtn")?.addEventListener("click", async () => {
  setBox(regErr, "");
  setBox(regOk, "");
  setBox(regErr, "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Ï Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ...");

  const username = (regUserInput?.value || "").trim();
  const email = (regEmailInput?.value || "").trim();
  const password = regPassInput?.value || "";

  if (!email || !password) { setBox(regErr, "Î’Î¬Î»Îµ Email ÎºÎ±Î¹ Password."); return; }
  if (password.length < 6) { setBox(regErr, "Î¤Î¿ password Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 6 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚."); return; }

  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: { data: { username } }
  });
  if (error) { setBox(regErr, error.message); return; }

  if (data?.user) await getOrCreateProfile(data.user, username);

  // success message in regOk box (green)
  regErr.style.display = "none";
  setBox(regOk, "ÎˆÎ³Î¹Î½Îµ âœ… Î‘Î½ Î­Ï‡ÎµÎ¹ email confirmation, Î­Î»ÎµÎ³Î¾Îµ Inbox/Spam ÎºÎ±Î¹ ÎºÎ¬Î½Îµ confirm.");
});

// ---------- Clear register ----------
$("regClearBtn")?.addEventListener("click", () => {
  if (regUserInput) regUserInput.value = "";
  if (regEmailInput) regEmailInput.value = "";
  if (regPassInput) regPassInput.value = "";
  setBox(regErr, "");
  setBox(regOk, "");
});

// ---------- Existing buttons (if present) ----------
doLogoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  location.reload();
});
goAdminBtn?.addEventListener("click", () => location.replace("admin.html"));
goClientBtn?.addEventListener("click", () => location.replace("dashboard.html"));
</script>
</body>
</html>
