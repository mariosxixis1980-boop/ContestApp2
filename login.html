<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cyprus Match Predict</title>
  <link rel="icon" href="favicon.ico"/>
  <style>
    :root{
      --bg:#071014;
      --panel:#0e1a20;
      --panel2:#0c141a;
      --txt:#e9f2f6;
      --muted:#a9c0cc;
      --accent:#86d24a;
      --accent2:#4aa3ff;
      --warn:#ffcc66;
      --err:#ff6b6b;
      --ok:#72ff9a;
      --line:#16313b;
      --btn:#13252e;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(134,210,74,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(74,163,255,.18), transparent 60%),
        linear-gradient(180deg, #071014 0%, #050b0f 100%);
      color:var(--txt);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width: 920px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      padding:26px 24px;
      background:
        linear-gradient(135deg, rgba(134,210,74,.18), rgba(74,163,255,.12)),
        radial-gradient(900px 500px at 30% 0%, rgba(255,255,255,.08), transparent 60%);
    }
    .hero h1{
      margin:0 0 6px;
      font-size:30px;
      letter-spacing:.2px;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      line-height:1.35;
      font-size:14px;
    }
    .hero .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:13px;
    }
    .hero .pill b{color:var(--txt); font-weight:600}
    .form{
      padding:22px 22px 18px;
      background: rgba(0,0,0,.18);
    }
    .tabs{
      display:flex;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding:4px;
      gap:4px;
      margin-bottom:14px;
    }
    .tab{
      flex:1;
      cursor:pointer;
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:600;
      transition: .15s;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(134,210,74,.22), rgba(134,210,74,.12));
      color:var(--txt);
    }
    label{
      display:block;
      margin:10px 0 6px;
      color:var(--muted);
      font-size:13px;
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      outline:none;
    }
    input:focus{border-color: rgba(134,210,74,.45)}
    .row{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: var(--btn);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      transition:.15s;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(134,210,74,.28), rgba(134,210,74,.12));
      border-color: rgba(134,210,74,.35);
    }
    .btn.link{
      background: transparent;
      border-color: rgba(255,255,255,.10);
      color: var(--muted);
      font-weight:600;
    }
    .msg{
      margin-top:10px;
      font-size:13px;
      line-height:1.35;
      color:var(--muted);
    }
    .msg.err{color: var(--err)}
    .msg.ok{color: var(--ok)}
    .msg.warn{color: var(--warn)}
    .small{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    a{color:#bfe8ff}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hero">
        <h1>Cyprus Match Predict</h1>
        <p>ÎŸ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î¸Î± Î±Î½Î±ÎºÎ¿Î¹Î½Ï‰Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±. ÎŸ admin Î¸Î± Î²Î¬Î»ÎµÎ¹ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿ Admin Panel.</p>
        <div class="pill">ğŸ—“ï¸ <span>ÎœÎ­Ï‡ÏÎ¹ Ï„ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ <b>login</b> ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬.</span></div>
      </div>

      <div class="form">
        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
          <button id="tabReg" class="tab" type="button">Î•Î³Î³ÏÎ±Ï†Î®</button>
        </div>

        <!-- LOGIN -->
        <div id="boxLogin">
          <label>Email</label>
          <input id="loginEmail" autocomplete="email" placeholder="name@example.com"/>

          <label>Password</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>

          <div class="row">
            <button id="loginBtn" class="btn primary" type="button">âœ… Login</button>
            <button id="loginClearBtn" class="btn link" type="button">ğŸ§¹ Clear</button>
            <button id="resetBtn" class="btn link" type="button">ğŸ” Reset Password</button>
          </div>

          <div id="loginErr" class="msg err"></div>
          <div id="loginOk" class="msg ok"></div>

          <div class="small">
            Tip: Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome. <br/>
            ÎœÎµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿Î´Î­Ï‡ÎµÏƒÏ„Îµ Ï„Î¿Ï…Ï‚ <b>ÎŒÏÎ¿Ï…Ï‚ & Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚</b> ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ <b>ÎšÎ±Î½ÏŒÎ½ÎµÏ‚</b>.
          </div>
        </div>

        <!-- REGISTER -->
        <div id="boxReg" style="display:none">
          <label>Username (Î¥Î ÎŸÎ§Î¡Î•Î©Î¤Î™ÎšÎŸ)</label>
          <input id="regUsername" autocomplete="username" placeholder="Ï€.Ï‡. theo"/>

          <label>Email</label>
          <input id="regEmail" autocomplete="email" placeholder="name@example.com"/>

          <label>Password</label>
          <input id="regPass" type="password" autocomplete="new-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>

          <div class="row">
            <button id="regBtn" class="btn primary" type="button">ğŸ†• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
            <button id="regClearBtn" class="btn link" type="button">ğŸ§¹ Clear</button>
          </div>

          <div id="regErr" class="msg err"></div>
          <div id="regOk" class="msg warn"></div>

          <div class="small">
            Î˜Î± ÏƒÎ¿Ï… Î­ÏÎ¸ÎµÎ¹ email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹ÎºÏ„ÏŒ ÏƒÏ„Î¿ Supabase Auth settings.
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="padding:18px 18px 16px; background:rgba(0,0,0,.18)">
      <h3 style="margin:6px 4px 10px; font-size:18px">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</h3>
      <div style="color:var(--muted); font-size:13px; line-height:1.45; padding:0 4px 10px;">
        â€¢ Î‘Î½ Î±Î½Î¿Î¯Î³ÎµÎ¹Ï‚ Ï„Î¿ <b>login.html</b> ÎºÎ±Î¹ ÏƒÎµ Ï€Î¬ÎµÎ¹ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ ÏƒÎµ admin/dashboard, ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ Supabase session (Î´ÎµÎ½ Î­Î³Î¹Î½Îµ signOut).<br/>
        â€¢ Î¤Î¿ <b>logout</b> Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹ <b>supabase.auth.signOut()</b> ÏƒÎµ admin & dashboard. <br/>
        â€¢ Î‘Î½ Ï€Î±Ï„Î¬Ï‚ Ï€Î¿Î»Î»Î­Ï‚ Ï†Î¿ÏÎ­Ï‚ register, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï†Î±Ï‚ <b>rate limit (429)</b> Î±Ï€ÏŒ Supabase (ÎµÎ¹Î´Î¹ÎºÎ¬ Î³Î¹Î± confirmation emails).<br/>
      </div>
    </div>
  </div>

  <script type="module">
    // ====== CONFIG ======
    const SUPABASE_URL = "https://nljrwvrmhlrpdgeougpk.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sand3dnJtaGxycGRnZW91Z3BrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MTA1NzUsImV4cCI6MjA1MzM4NjU3NX0.7SH5lXk4y3SgF8Hf7Ew4R0Zq9n0oQp0m1Rkq4Qp0m1A";
    const ADMIN_EMAIL = "admin@cmp.com"; // Î¬Î»Î»Î±Î¾Î­ Ï„Î¿ ÏƒÏ„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ¿Ï… admin email Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚

    // ====== INIT ======
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const byId = (id)=>document.getElementById(id);
    const setInlineMsg = (id, msg)=>{ byId(id).textContent = msg || ""; }
    const clearMsgs = ()=>{
      setInlineMsg("loginErr","");
      setInlineMsg("loginOk","");
      setInlineMsg("regErr","");
      setInlineMsg("regOk","");
    }

    function showLogin(){
      byId("boxLogin").style.display = "";
      byId("boxReg").style.display = "none";
      byId("tabLogin").classList.add("active");
      byId("tabReg").classList.remove("active");
    }
    function showReg(){
      byId("boxLogin").style.display = "none";
      byId("boxReg").style.display = "";
      byId("tabReg").classList.add("active");
      byId("tabLogin").classList.remove("active");
    }

    byId("tabLogin").onclick = showLogin;
    byId("tabReg").onclick = showReg;

    byId("loginClearBtn").onclick = ()=>{
      byId("loginEmail").value="";
      byId("loginPass").value="";
      clearMsgs();
    };
    byId("regClearBtn").onclick = ()=>{
      byId("regUsername").value="";
      byId("regEmail").value="";
      byId("regPass").value="";
      clearMsgs();
    };

    async function goAfterLogin(session){
      const email = String(session?.user?.email || "").toLowerCase();
      const isAdmin = (email === String(ADMIN_EMAIL).toLowerCase());

      // (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î³Î¹Î± legacy pages
      localStorage.setItem("cmp_session", JSON.stringify({
        username: session?.user?.email || "",
        email: session?.user?.email || "",
        isAdmin
      }));

      if(isAdmin){
        location.href = "admin.html";
      }
      else{
        location.href = "dashboard.html";
      }
    }

    async function doLogin(){
      clearMsgs();
      const email = String(byId("loginEmail").value || "").trim().toLowerCase();
      const password = String(byId("loginPass").value || "");

      if(!email || !password){
        return setInlineMsg("loginErr","Î“ÏÎ¬ÏˆÎµ email ÎºÎ±Î¹ password.");
      }

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){
        return setInlineMsg("loginErr","Login error: " + (error.message || String(error)));
      }
      if(!data?.session){
        return setInlineMsg("loginErr","Î”ÎµÎ½ Î­Î³Î¹Î½Îµ session. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.");
      }
      setInlineMsg("loginOk","âœ… Login OK");
      await goAfterLogin(data.session);
    }

    async function doResetPassword(){
      clearMsgs();
      const email = String(byId("loginEmail").value || "").trim().toLowerCase();
      if(!email) return setInlineMsg("loginErr","Î’Î¬Î»Îµ Ï€ÏÏÏ„Î± email Î³Î¹Î± reset.");
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if(error) return setInlineMsg("loginErr","Reset error: " + (error.message || String(error)));
      setInlineMsg("loginOk","âœ… Î£Ï„Î¬Î»Î¸Î·ÎºÎµ email Î³Î¹Î± reset (Î±Î½ Ï„Î¿ email Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).");
    }

    async function doRegister(){
      clearMsgs();
      const usernameRaw = String(byId("regUsername").value || "").trim();
      const email = String(byId("regEmail").value || "").trim().toLowerCase();
      const password = String(byId("regPass").value || "");

      if(!email || !password){
        return setInlineMsg("regErr","Î“ÏÎ¬ÏˆÎµ email ÎºÎ±Î¹ password.");
      }

      // username Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒ ÏƒÏ„Î· Î²Î¬ÏƒÎ· (profiles.username ÎµÎ¯Î½Î±Î¹ NOT NULL)
      let username = usernameRaw || (email.split("@")[0] || "").trim();
      if(!username){
        username = "user_" + Math.random().toString(36).slice(2,8);
      }

      // Î‘Î½ ÎºÎ¬Ï€Î¿Î¹Î¿Ï‚ Î²Î¬Î»ÎµÎ¹ Ï„Î¿ admin email Î±Ï€ÏŒ Ï„Î¿ register, Ï„Î¿ ÎºÎ¬Î½Î¿Ï…Î¼Îµ admin profile
      const isAdmin = (email === ADMIN_EMAIL);

      // 1) Create auth user
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error){
        // Supabase errors (Ï€.Ï‡. "User already registered", rate limit, ÎºÏ„Î»)
        return setInlineMsg("regErr", "Register error: " + (error.message || String(error)));
      }
      const user = data?.user;
      if(!user?.id){
        return setInlineMsg("regErr", "Register error: Î”ÎµÎ½ Ï€Î®ÏÎ± user id Î±Ï€ÏŒ Supabase.");
      }

      // 2) Create/Update profile row
      // Î£Ï„Î· Î²Î¬ÏƒÎ· Î· ÏƒÏ„Î®Î»Î· ÎµÎ¯Î½Î±Î¹ is_admin (ÏŒÏ‡Î¹ isAdmin)
      const baseProfile = { id: user.id, username, email, is_admin: isAdmin };

      // Î‘Î½ Ï„Î¿ username ÎµÎ¯Î½Î±Î¹ Î®Î´Î· Ï€Î¹Î±ÏƒÎ¼Î­Î½Î¿ (unique), Î´Î¿ÎºÎ¹Î¼Î¬Î¶Î¿Ï…Î¼Îµ 1 Ï†Î¿ÏÎ¬ Î¼Îµ suffix
      let profilePayload = baseProfile;
      let { error: pErr } = await supabase.from("profiles").upsert(profilePayload, { onConflict: "id" });

      if(pErr && String(pErr.code) === "23505"){
        // duplicate key -> Î¬Î»Î»Î±Î¾Îµ username ÎºÎ±Î¹ Î¾Î±Î½Î±Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ
        profilePayload = { ...baseProfile, username: `${username}_${Math.random().toString(36).slice(2,5)}` };
        const retry = await supabase.from("profiles").upsert(profilePayload, { onConflict: "id" });
        pErr = retry.error;
      }

      if(pErr){
        console.warn("profiles upsert error:", pErr);
        // Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ register ÏƒÏ„Î¿ Auth, Î±Ï€Î»Î¬ Î´ÎµÎ½ Î³ÏÎ¬Ï†Ï„Î·ÎºÎµ profile
        return setInlineMsg("regOk",
          "Î— ÎµÎ³Î³ÏÎ±Ï†Î® Î­Î³Î¹Î½Îµ, Î±Î»Î»Î¬ Î´ÎµÎ½ Î³ÏÎ¬Ï†Ï„Î·ÎºÎµ profile. (ÎˆÎ»ÎµÎ³Î¾Îµ RLS / table rules). " + (pErr.message || "")
        );
      }

      setInlineMsg("regOk","âœ… Î— ÎµÎ³Î³ÏÎ±Ï†Î® Î­Î³Î¹Î½Îµ! Î¤ÏÏÎ± ÎºÎ¬Î½Îµ login. (ÎŠÏƒÏ‰Ï‚ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ email confirm.)");
      showLogin();
    }

    // INIT
    (async () => {
      showLogin();
      clearMsgs();

      const { data: sessData, error } = await supabase.auth.getSession();
      if(error) console.warn("getSession error:", error);

      if(sessData?.session){
        // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ session, Î¸Î± Î³Î¯Î½ÎµÎ¹ redirect (admin Î® dashboard)
        await goAfterLogin(sessData.session);
        return;
      }

      supabase.auth.onAuthStateChange((_event, session) => {
        if(session) goAfterLogin(session);
      });

      byId("loginBtn").addEventListener("click", doLogin);
      byId("resetBtn").addEventListener("click", doResetPassword);
      byId("regBtn").addEventListener("click", doRegister);

      console.log("SUPABASE OK");
    })();
  </script>
</body>
</html>
