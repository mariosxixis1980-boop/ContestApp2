<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cyprus Match Predict - Login</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1b1b;color:#e7f3f3}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 6px;font-size:28px}
    .sub{opacity:.85;margin:0 0 14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;margin:10px 0 6px;opacity:.9}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:#fff;outline:none}
    input:focus{border-color:rgba(120,255,255,.35)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:#fff;border-radius:12px;padding:10px 12px}
    button.primary{background:linear-gradient(90deg,rgba(36,160,150,.55),rgba(36,120,160,.55))}
    button.danger{background:rgba(180,50,60,.35)}
    .mini{font-size:12px;opacity:.85;margin-top:10px}
    .msg{margin-top:10px;font-size:13px}
    .msg.err{color:#ffb3b3}
    .msg.ok{color:#b9ffd6}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);margin-right:6px}
    .hidden{display:none}
    hr{border:none;border-top:1px solid rgba(255,255,255,.12);margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ” Login</h1>
      <p class="sub">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Email &amp; Password (Supabase).</p>

      <div id="settingsBox" class="hidden">
        <div class="pill">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Supabase</div>
        <div class="mini">Î’Î¬Î»Îµ Ï„Î¿ <b>Project URL</b> ÎºÎ±Î¹ Ï„Î¿ <b>anon key</b> (ÏŒÏ‡Î¹ service role). Î˜Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„Î¿ÏÎ½ ÏƒÏ„Î¿ browser ÏƒÎ¿Ï….</div>
        <div class="row">
          <div class="col">
            <label for="sbUrl">Project URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co"/>
          </div>
          <div class="col">
            <label for="sbAnon">Anon public key</label>
            <input id="sbAnon" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."/>
          </div>
        </div>
        <div class="btns">
          <button id="saveSettingsBtn" class="primary" type="button">Save</button>
          <button id="clearSettingsBtn" type="button">Clear settings</button>
        </div>
        <div id="settingsMsg" class="msg"></div>
        <hr/>
      </div>

      <div id="alreadyBox" class="hidden">
        <div class="pill">Î•Î¯ÏƒÎ±Î¹ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚</div>
        <div class="mini" id="alreadyText"></div>
        <div class="btns">
          <button id="goDashboardBtn" class="primary" type="button">Î ÎµÎ»Î¬Ï„Î·Ï‚ (Dashboard)</button>
          <button id="goAdminBtn" class="primary" type="button">Admin</button>
          <button id="logoutBtn" class="danger" type="button">Logout</button>
        </div>
        <div id="alreadyMsg" class="msg"></div>
        <hr/>
      </div>

      <div class="row">
        <div class="col">
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="email@example.com"/>
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
          <div class="btns">
            <button id="loginBtn" class="primary" type="button">Login</button>
            <button id="resetBtn" type="button">Reset Password</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>
          <div id="loginMsg" class="msg"></div>
          <div class="mini">Tip: Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ â€œÎºÏ‰Î´Î¹ÎºÏŒ Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…â€, ÎµÎ¯Î½Î±Î¹ autofill Ï„Î¿Ï… Chrome.</div>
        </div>

        <div class="col">
          <div class="pill">Register</div>
          <label for="regUser">Username (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
          <input id="regUser" autocomplete="username" placeholder="Ï€.Ï‡ marios10"/>
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" autocomplete="email" placeholder="Ï€.Ï‡ name@gmail.com"/>
          <label for="regPass">Password</label>
          <input id="regPass" type="password" autocomplete="new-password" placeholder="Î´Î¹Î¬Î»ÎµÎ¾Îµ password"/>
          <div class="btns">
            <button id="regBtn" class="primary" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
            <button id="regClearBtn" type="button">Clear</button>
          </div>
          <div id="regMsg" class="msg"></div>
          <div class="mini">âš ï¸ Î‘Î½ Î´ÎµÎ½ Î­ÏÏ‡ÎµÏ„Î±Î¹ email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚, Î´ÎµÏ‚ Supabase â†’ Auth â†’ Settings.</div>
        </div>
      </div>

      <hr/>
      <div class="mini">
        Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÏƒÏ„Î¿Î¹Ï‡Î®Î¼Î±Ï„Î¿Ï‚. ÎœÎµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿Î´Î­Ï‡ÎµÏƒÎ±Î¹ Ï„Î¿Ï…Ï‚ ÎŒÏÎ¿Ï…Ï‚ &amp; Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ ÎšÎ±Î½ÏŒÎ½ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï.
      </div>
    </div>
  </div>

  <!-- Supabase UMD (global window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  (function(){
    'use strict';

    const LS_URL = 'SB_URL';
    const LS_ANON = 'SB_ANON';
    const LS_USER = 'CMP_USER';
    const LS_PROFILE = 'CMP_PROFILE';

    const $ = (id) => document.getElementById(id);

    const ui = {
      settingsBox: $('settingsBox'),
      sbUrl: $('sbUrl'),
      sbAnon: $('sbAnon'),
      saveSettingsBtn: $('saveSettingsBtn'),
      clearSettingsBtn: $('clearSettingsBtn'),
      settingsMsg: $('settingsMsg'),

      alreadyBox: $('alreadyBox'),
      alreadyText: $('alreadyText'),
      alreadyMsg: $('alreadyMsg'),
      goDashboardBtn: $('goDashboardBtn'),
      goAdminBtn: $('goAdminBtn'),
      logoutBtn: $('logoutBtn'),

      email: $('email'),
      password: $('password'),
      loginBtn: $('loginBtn'),
      resetBtn: $('resetBtn'),
      clearBtn: $('clearBtn'),
      loginMsg: $('loginMsg'),

      regUser: $('regUser'),
      regEmail: $('regEmail'),
      regPass: $('regPass'),
      regBtn: $('regBtn'),
      regClearBtn: $('regClearBtn'),
      regMsg: $('regMsg'),
    };

    function setMsg(el, text, kind){
      el.classList.remove('err','ok');
      if(kind) el.classList.add(kind);
      el.textContent = text || '';
    }

    function getSettings(){
      return {
        url: localStorage.getItem(LS_URL) || '',
        anon: localStorage.getItem(LS_ANON) || '',
      };
    }

    function ensureSettings(){
      const s = getSettings();
      const ok = !!(s.url && s.anon);
      ui.settingsBox.classList.toggle('hidden', ok);
      if(!ok){
        ui.sbUrl.value = s.url;
        ui.sbAnon.value = s.anon;
      }
      return ok;
    }

    function createSb(){
      const s = getSettings();
      const { createClient } = window.supabase || {};
      if(!createClient) throw new Error('Supabase library did not load.');
      if(!s.url || !s.anon) throw new Error('Missing Supabase URL/anon key.');
      return createClient(s.url, s.anon);
    }

    async function fetchProfile(sb, email){
      // users table: username, email, is_admin (bool)
      const { data, error } = await sb
        .from('users')
        .select('username,email,is_admin')
        .eq('email', email)
        .maybeSingle();

      if(error) throw error;
      return data || null;
    }

    function routeAfterLogin(profile){
      // Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ profile, Ï€Î¬Î¼Îµ dashboard (ÎºÎ±Î¹ Ï„Î¿ Ï†Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î¼ÎµÏ„Î¬)
      if(profile && profile.is_admin === true) {
        window.location.href = 'admin.html';
        return;
      }
      window.location.href = 'dashboard.html';
    }

    async function showAlready(sb, session){
      // Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ profile Î³Î¹Î± ÏƒÏ‰ÏƒÏ„Î® Î´ÏÎ¿Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·
      let profile = null;
      try { profile = await fetchProfile(sb, session.user.email); } catch(_) {}

      ui.alreadyBox.classList.remove('hidden');
      const username = profile?.username || session.user.email;
      ui.alreadyText.textContent = 'Î£Ï…Î½Î´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚: ' + username + ' (' + session.user.email + ')';

      ui.goAdminBtn.disabled = !(profile && profile.is_admin === true);
      ui.goAdminBtn.title = ui.goAdminBtn.disabled ? 'Î”ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ admin.' : '';

      ui.goDashboardBtn.onclick = () => window.location.href = 'dashboard.html';
      ui.goAdminBtn.onclick = () => {
        if(profile && profile.is_admin === true) window.location.href = 'admin.html';
      };

      ui.logoutBtn.onclick = async () => {
        setMsg(ui.alreadyMsg, 'Î“Î¯Î½ÎµÏ„Î±Î¹ logout...', '');
        const { error } = await sb.auth.signOut();
        localStorage.removeItem(LS_USER);
        localStorage.removeItem(LS_PROFILE);
        if(error) setMsg(ui.alreadyMsg, 'Logout error: ' + error.message, 'err');
        else {
          ui.alreadyBox.classList.add('hidden');
          setMsg(ui.alreadyMsg, '', '');
          setMsg(ui.loginMsg, 'ÎˆÎ³Î¹Î½ÎµÏ‚ logout. ÎšÎ¬Î½Îµ login Î¾Î±Î½Î¬.', 'ok');
        }
      };
    }

    async function main(){
      // Settings buttons
      ui.saveSettingsBtn.onclick = () => {
        const url = (ui.sbUrl.value || '').trim();
        const anon = (ui.sbAnon.value || '').trim();
        if(!url || !anon){
          setMsg(ui.settingsMsg, 'Î’Î¬Î»Îµ Project URL ÎºÎ±Î¹ anon key.', 'err');
          return;
        }
        localStorage.setItem(LS_URL, url);
        localStorage.setItem(LS_ANON, anon);
        setMsg(ui.settingsMsg, 'OK. ÎˆÎ³Î¹Î½Îµ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·. ÎšÎ¬Î½Îµ refresh.', 'ok');
      };

      ui.clearSettingsBtn.onclick = () => {
        localStorage.removeItem(LS_URL);
        localStorage.removeItem(LS_ANON);
        setMsg(ui.settingsMsg, 'ÎˆÎ³Î¹Î½Îµ clear. ÎšÎ¬Î½Îµ refresh.', 'ok');
      };

      // Basic UI buttons
      ui.clearBtn.onclick = () => { ui.email.value=''; ui.password.value=''; setMsg(ui.loginMsg,'',''); };
      ui.regClearBtn.onclick = () => { ui.regUser.value=''; ui.regEmail.value=''; ui.regPass.value=''; setMsg(ui.regMsg,'',''); };

      if(!ensureSettings()){
        // Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î¼Îµ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ => ÏƒÏ„Î±Î¼Î±Ï„Î¬Î¼Îµ ÎµÎ´Ï
        setMsg(ui.loginMsg, 'Î ÏÏÏ„Î± Î²Î¬Î»Îµ Supabase ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï€Î¹Î¿ Ï€Î¬Î½Ï‰.', 'err');
        return;
      }

      const sb = createSb();
      console.log('Supabase ready');

      // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· session, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± â€œÎ¼Ï€Î»Î­ÎºÎµÎ¹â€ Ï„Î¿ login)
      const { data: sessData } = await sb.auth.getSession();
      if(sessData && sessData.session){
        await showAlready(sb, sessData.session);
      }

      ui.loginBtn.onclick = async () => {
        setMsg(ui.loginMsg, 'Î“Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏÎ½Î´ÎµÏƒÎ·...', '');
        const email = (ui.email.value || '').trim();
        const password = ui.password.value || '';
        if(!email || !password){
          setMsg(ui.loginMsg, 'Î’Î¬Î»Îµ email ÎºÎ±Î¹ password.', 'err');
          return;
        }

        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          setMsg(ui.loginMsg, 'Login error: ' + error.message, 'err');
          return;
        }

        // Fetch profile
        let profile = null;
        try { profile = await fetchProfile(sb, data.user.email); }
        catch(e){ console.warn('Profile fetch failed:', e); }

        // Save
        localStorage.setItem(LS_USER, JSON.stringify(data.user));
        localStorage.setItem(LS_PROFILE, JSON.stringify(profile));

        routeAfterLogin(profile);
      };

      ui.resetBtn.onclick = async () => {
        setMsg(ui.loginMsg, 'Reset: Î³ÏÎ¬ÏˆÎµ email Ï€ÏÏÏ„Î±...', '');
        const email = (ui.email.value || '').trim();
        if(!email){
          setMsg(ui.loginMsg, 'Î“ÏÎ¬ÏˆÎµ email Î³Î¹Î± reset.', 'err');
          return;
        }
        const { error } = await sb.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/') + 'login.html'
        });
        if(error) setMsg(ui.loginMsg, 'Reset error: ' + error.message, 'err');
        else setMsg(ui.loginMsg, 'Î£Î¿Ï… Î­ÏƒÏ„ÎµÎ¹Î»Îµ email Î³Î¹Î± reset (Î±Î½ Ï„Î¿ email Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).', 'ok');
      };

      ui.regBtn.onclick = async () => {
        setMsg(ui.regMsg, 'Î“Î¯Î½ÎµÏ„Î±Î¹ ÎµÎ³Î³ÏÎ±Ï†Î®...', '');
        const username = (ui.regUser.value || '').trim();
        const email = (ui.regEmail.value || '').trim();
        const password = ui.regPass.value || '';
        if(!email || !password){
          setMsg(ui.regMsg, 'Î’Î¬Î»Îµ email ÎºÎ±Î¹ password.', 'err');
          return;
        }

        const { data, error } = await sb.auth.signUp({ email, password });
        if(error){
          setMsg(ui.regMsg, 'Register error: ' + error.message, 'err');
          return;
        }

        // Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ profile row (Î±Î½ RLS/permissions Ï„Î¿ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½)
        try{
          await sb.from('users').upsert({
            email,
            username: username || email.split('@')[0],
            is_admin: false
          }, { onConflict: 'email' });
        }catch(e){
          console.warn('Could not write users row (RLS?):', e);
        }

        setMsg(ui.regMsg, 'OK! Î‘Î½ Î­Ï‡ÎµÎ¹Ï‚ email confirmation, Î­Î»ÎµÎ³Î¾Îµ Ï„Î¿ inbox ÏƒÎ¿Ï….', 'ok');
      };
    }

    main().catch((e)=>{
      console.error('Login page fatal error:', e);
      alert('ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ Î»Î¬Î¸Î¿Ï‚ ÏƒÏ„Î¿ login. Î”ÎµÏ‚ Console.');
    });
  })();
  </script>
</body>
</html>
